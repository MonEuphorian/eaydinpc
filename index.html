<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>CSI: CodeBreaker</title>
    <style>
        /* Temel Stil */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
            user-select: none;
            -webkit-user-select: none;
        }
        
        body {
            background-color: #0a0a0a;
            color: #33ff33;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            padding: 15px;
            position: relative;
        }
        
        /* Matrix benzeri arka plan */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(0, 0, 0, 0.97), rgba(0, 0, 0, 0.97)), 
                        url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Ctext x='10' y='20' fill='rgba(51, 255, 51, 0.1)' font-family='monospace'%3E01%3C/text%3E%3Ctext x='60' y='40' fill='rgba(51, 255, 51, 0.1)' font-family='monospace'%3E10%3C/text%3E%3Ctext x='30' y='60' fill='rgba(51, 255, 51, 0.1)' font-family='monospace'%3E01%3C/text%3E%3Ctext x='70' y='80' fill='rgba(51, 255, 51, 0.1)' font-family='monospace'%3E10%3C/text%3E%3C/svg%3E");
            z-index: -1;
        }
        
        /* Başlık - kaldırıldı */
        /* .title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 0 10px #33ff33;
        } */
        
        /* Game Container - Yatay ekran için genişletildi */
        .game-container {
            width: 100%;
            max-width: 800px; /* Temel genişlik */
            background-color: rgba(17, 17, 17, 0.95);
            border: 2px solid #33ff33;
            border-radius: 10px;
            padding: 30px; /* Daha fazla iç boşluk */
            box-shadow: 0 0 20px rgba(51, 255, 51, 0.3);
            position: relative;
        }
        
        /* Oyun Başlığı - Container içinde - Kaldırıldı */
        /* .game-title {
            font-size: 1.2rem;
            text-align: center;
            margin-bottom: 15px;
            text-shadow: 0 0 10px #33ff33;
        } */
        
        /* Timer */
        .timer {
            position: absolute;
            bottom: 20px;
            right: 20px;
            font-size: 2rem; /* Daha büyük zaman göstergesi */
            color: #33ff33; /* Başlangıç rengi yeşil */
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: bold;
        }
        
        /* Status - Kaldırıldı */
        /* .status {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.2rem;
        } */
        
        /* Rows */
        .password-row, .code-row {
            display: flex;
            justify-content: space-between;
        }
        
        .password-row {
            margin-bottom: 70px; /* Üst ve alt kutular arasındaki mesafeyi artırdım */
            margin-top: 20px; /* Üst kutuların üstündeki boşluğu artır */
        }
        
        .code-row {
            margin-bottom: 30px; /* Alt kutularla butonlar arası mesafeyi artır */
        }
        
        /* Boxes - Daha büyük kutular ve responsive */
        .box {
            width: 60px; /* Temel genişlik */
            height: 60px; /* Temel yükseklik */
            background-color: #000;
            border: 3px solid #00ffff; /* Turkuaz kenarlık */
            border-radius: 8px; /* Hafif yuvarlatılmış köşeler */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem; /* Daha büyük yazı boyutu */
            position: relative;
            transition: all 0.3s ease;
        }
        
        .password-box {
            color: #fff;
            background-color: #222;
            position: relative;
            border: 3px solid #33ff33; /* Password kutuları yeşil kalsın */
        }
        
        .password-box::after {
            content: '';
            position: absolute;
            width: 2px; /* Çizgi kalınlığı */
            background-color: rgba(50, 50, 50, 0.7); /* Koyu gri çizgi rengi */
            top: 100%; /* Kutunun alt kenarından başla */
            left: 50%; /* Kutunun yatay ortasından */
            transform: translateX(-50%); /* Tam ortadan hizala */
            height: calc(var(--box-spacing) - 0px); /* Üst ve alt kutular arası mesafe */
            z-index: 1; /* Çizgiyi diğer elementlerin üzerine çıkar */
        }
        
        .password-box.solved::after {
            background-color: rgba(50, 50, 50, 0.7); /* Çözülmüş kutular için de koyu gri */
        }
        
        .spinning {
            overflow: hidden;
        }
        
        .spinner {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* Shield */
        .shield {
            position: absolute;
            width: 100%;
            height: 70px; /* Daha yüksek shield */
            background-color: rgba(255, 255, 0, 0.2);
            border: 2px solid yellow;
            border-radius: 5px;
            z-index: 1;
            display: none;
        }
        
        /* Control buttons */
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px; /* Butonlar arası daha fazla boşluk */
            margin-bottom: 20px;
        }
        
        .btn {
            background-color: #111;
            color: #33ff33;
            border: 3px solid #33ff33; /* Daha kalın kenarlık */
            border-radius: 8px;
            padding: 12px 25px; /* Daha büyük butonlar */
            font-size: 1.2rem; /* Daha büyük yazı boyutu */
            cursor: pointer;
            transition: all 0.3s;
            outline: none;
            touch-action: manipulation;
        }
        
        .btn:hover, .btn:active {
            background-color: #222;
            box-shadow: 0 0 10px rgba(51, 255, 51, 0.5);
        }
        
        /* Aktif buton vurgusu */
        .btn-active {
            background-color: #222;
            box-shadow: 0 0 15px rgba(51, 255, 51, 0.7);
        }
        
        /* Game screens */
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 999;
            padding: 20px;
            text-align: center;
        }
        
        /* Start ekranı flex kolon düzeni */
        #start-screen {
            display: flex;
            flex-direction: column;
            padding: 20px;
        }
        
        /* İçerik bloğu büyüsün, taşınca kaydırsın */
        #start-screen .scrollable {
            flex: 1 1 auto;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* Buton hep altında kalsın */
        #start-btn {
            flex-shrink: 0;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Selected box */
        .selected {
            border-color: #00ffff;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.7); /* Turkuaz parıltı */
        }
        
        /* Success and error indicators */
        .success {
            border-color: #00ffff;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.7); /* Turkuaz parıltı */
        }
        
        .error {
            border-color: #ff0000;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.7); /* Kırmızı parıltı - aynı kalsın */
        }

        /* Yeni eklenen stil - parlayan çiftler ve çözülmüş kutu */
        .highlight {
            border-color: #00ffff;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.7);
            animation: highlight-pulse 1.5s infinite;
        }

        .solved {
            color: #00ffff !important; /* Karakter rengi turkuaz */
            border-color: #00ffff; /* Kutunun kenarı turkuaz */
            box-shadow: 0 0 5px rgba(0, 255, 255, 0.3); /* Hafif turkuaz parlama */
        }

        /* Animasyonlar */
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        
        @keyframes shield-blink {
            0% { opacity: 0.7; }
            50% { opacity: 0.3; }
            100% { opacity: 0.7; }
        }
        
        .shield {
            animation: shield-blink 0.8s infinite;
        }

        /* Yatay ekran için ek optimizasyonlar */
        @media (orientation: landscape) {
            .game-container {
                max-width: 95vw; /* Daha geniş alan */
                max-height: 92vh; /* Maksimum yükseklik */
                padding: 25px 35px 25px 35px; /* Yatay ve dikey padding */
                display: flex;
                flex-direction: column;
                justify-content: space-between;
            }
            
            body {
                padding: 0;
            }
            
            .box {
                width: 65px; /* Yatay ekranda biraz daha büyük kutular */
                height: 65px;
            }
            
            .password-row {
                margin-bottom: 80px; /* Üst ve alt kutular arasındaki mesafeyi daha fazla artırdım */
                margin-top: 5px; /* Üst kutuları daha yukarıya taşı */
            }
            
            .code-row {
                margin-bottom: 20px; /* Alt kutularla buton arasındaki mesafeyi azalt */
            }
            
            .stage-indicator {
                bottom: 10px;
                left: 20px;
                font-size: 0.9rem;
            }
            
            .timer {
                bottom: 10px;
                right: 20px;
                font-size: 2.2rem;
            }
            
            .controls {
                margin-top: 10px; /* Butonların alttan mesafesini azalt */
                margin-bottom: 20px; /* Butonların alttan mesafesini ayarla */
            }
            
            /* Başlangıç ekranı, kazanma ekranı ve diğer ekranlar için ayarlar */
            .screen {
                padding: 15px;
            }
        }

        /* Küçük ekranlar için kutu boyutları */
        @media (max-width: 600px) {
            .box {
                width: 50px;
                height: 50px;
                font-size: 1.8rem;
            }
            
            .stage-indicator, .timer {
                font-size: 1rem;
                padding: 6px 10px;
            }
        }
        
        /* Çok küçük ekranlar için daha da küçük kutular */
        @media (max-width: 450px) {
            .box {
                width: 40px;
                height: 40px;
                font-size: 1.5rem;
                border-width: 2px;
            }
            
            .password-row {
                margin-bottom: 20px;
                margin-top: 30px;
            }
            
            .controls .btn {
                padding: 8px 15px;
                font-size: 1rem;
            }
        }

        /* Aşama 2 için özel buton stil */
        .connect-stage2 {
            background-color: #333;
            color: #00ffff;
            border-color: #00ffff;
        }
        
        /* Pulse animasyonu */
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Etap tamamlandı göstergesi */
        .stage-indicator {
            position: absolute;
            bottom: 20px;
            left: 20px;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 1rem;
            color: #888;
        }
        
        /* Final animasyonu için etki */
        @keyframes glitch {
            0% { transform: translate(0); text-shadow: 0 0 0 #00ffff; }
            2% { transform: translate(-2px, 2px); text-shadow: -2px 2px 0 #ff00ff; }
            4% { transform: translate(2px, -2px); text-shadow: 2px -2px 0 #ff0000; }
            6% { transform: translate(0); text-shadow: 0 0 0 #00ffff; }
            100% { transform: translate(0); text-shadow: 0 0 0 #00ffff; }
        }
        
        .glitch-effect {
            animation: glitch 2s infinite;
        }
        
        @keyframes highlight-pulse {
            0% { box-shadow: 0 0 15px rgba(0, 255, 255, 0.7); }
            50% { box-shadow: 0 0 25px rgba(0, 255, 255, 0.9); }
            100% { box-shadow: 0 0 15px rgba(0, 255, 255, 0.7); }
        }

        /* Geniş ekranlar için özel ayarlar */
        @media (min-width: 1200px) {
            .game-container {
                max-width: 1000px; /* Çok geniş ekranlarda daha da geniş */
            }
            
            .box {
                width: 70px; /* Geniş ekranlarda daha büyük kutular */
                height: 70px;
                font-size: 2.2rem;
            }
        }

        /* Çok büyük ekranlar için Game Container'ı yükselt */
        @media (min-height: 800px) {
            .game-container {
                padding: 40px 30px; /* Dikey pad artır */
            }
            
            .password-row {
                margin-bottom: 100px; /* Üst ve alt kutular arasındaki mesafeyi daha da artır */
                margin-top: 20px; /* Üst kutuların üst kenar boşluğunu artır */
            }
            
            .code-row {
                margin-bottom: 40px; /* Alt sıra ile buton arası mesafeyi artır */
            }
            
            .box {
                width: 70px; /* Kutuları biraz daha büyüt */
                height: 70px;
            }
        }

        /* Full-height Game Container için düzenleme */
        @media (min-height: 900px) and (orientation: landscape) {
            .game-container {
                max-height: 95vh; /* Daha da büyük yükseklik */
                display: flex;
                flex-direction: column;
                justify-content: center; /* Dikey ortala */
                align-items: center; /* Yatay ortala */
                padding: 50px 40px; /* Daha fazla padding */
            }
            
            .box {
                width: 75px;
                height: 75px;
                font-size: 2.2rem;
            }
            
            .password-row {
                margin-bottom: 120px; /* Daha fazla boşluk - alt kutuları daha aşağıya taşıdım */
            }
            
            .code-row {
                margin-bottom: 50px;
            }
            
            .controls .btn {
                padding: 15px 30px;
                font-size: 1.5rem;
            }
        }

        /* Çözüm durumundaki geçiş efekti için animasyon */
        @keyframes connection-success {
            0% { background-color: rgba(50, 50, 50, 0.7); } /* Koyu gri başlangıç */
            50% { background-color: rgba(0, 255, 255, 0.7); } /* Turkuaz vurgu */
            100% { background-color: rgba(50, 50, 50, 0.7); } /* Koyu gri bitiş */
        }

        /* Bu stil, çözüm durumunda kutular arasındaki bağlantı çizgisinin animasyonunu sağlar */
        .password-box.success::after {
            animation: connection-success 1s forwards;
        }

        /* Kilit İkonu */
        .lock-icon {
            position: absolute;
            width: 24px;
            height: 24px;
            z-index: 5; /* Bağlantı çizgilerinin üzerinde */
            opacity: 0.7;
            display: none; /* Başlangıçta gizli */
            transform: translate(-50%, -50%); /* Tam merkeze hizala */
            transition: all 0.3s ease;
        }

        /* Kilit ikonu içindeki SVG */
        .lock-icon svg {
            width: 100%;
            height: 100%;
            fill: #555;
            stroke: #00ffff;
            stroke-width: 1px;
            transition: all 0.3s ease;
        }

        /* Aktif kilit ikonu */
        .lock-icon.active {
            display: block;
        }
        
        /* Vurgulanan kilit ikonu */
        .lock-icon.highlight svg {
            fill: #333;
            stroke: #00ffff;
            stroke-width: 2px;
            filter: drop-shadow(0 0 5px rgba(0, 255, 255, 0.7));
        }
        
        /* Çözülmüş kilit ikonu */
        .lock-icon.solved svg {
            fill: #555; /* Orijinal fill rengi korunuyor */
            stroke: #00ffff; /* Turkuaz stroke rengi */
            stroke-width: 1px; /* Orijinal çizgi kalınlığı korunuyor */
            filter: none; /* Drop shadow efektini kaldır */
        }
        
        /* Responsive kilit boyutları */
        @media (min-width: 1200px) {
            .lock-icon {
                width: 28px;
                height: 28px;
            }
        }
        
        @media (max-width: 600px) {
            .lock-icon {
                width: 20px;
                height: 20px;
            }
        }
        
        @media (max-width: 450px) {
            .lock-icon {
                width: 16px;
                height: 16px;
            }
        }

        /* Geçici çözülme vurgusu için stil */
        .temp-highlight {
            border-color: #00ffff !important;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.7) !important;
        }

        /* YENİ: Aşama 1 Animasyonları */
        /* Pulse animasyonu - Alt kutu için */
        @keyframes stage1-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.08); filter: brightness(1.3); }
            100% { transform: scale(1); }
        }
        
        /* Enerji akışı animasyonu */
        @keyframes energy-flow {
            0% { 
                height: 0%; 
                opacity: 0.7; 
                background-position: 0% 100%; 
            }
            100% { 
                height: 100%; 
                opacity: 0; 
                background-position: 0% 0%; 
            }
        }
        
        /* Parçacık animasyonu */
        @keyframes particle-flow {
            0% { 
                transform: translateY(0); 
                opacity: 0.9;
                filter: blur(1px) brightness(1.5);
            }
            100% { 
                transform: translateY(-100%); 
                opacity: 0;
                filter: blur(0px) brightness(1);
            }
        }
        
        /* Üst kutu parlaması */
        @keyframes top-box-glow {
            0% { 
                box-shadow: 0 0 2px #00ffff, 0 0 5px #00ffff;
                border-color: #00ffff; 
            }
            50% { 
                box-shadow: 0 0 15px #00ffff, 0 0 25px #00ffff;
                border-color: #00ffff; 
            }
            100% { 
                box-shadow: 0 0 2px #00ffff, 0 0 5px #00ffff;
                border-color: #00ffff; 
            }
        }
        
        /* Karakter renk değişimi */
        @keyframes char-color-change {
            0% { color: #fff; }
            100% { color: #00ffff; }
        }
        
        /* Enerji akışı kapsayıcısı */
        .energy-flow-container {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 6;
        }
        
        /* Enerji çizgisi */
        .energy-line {
            position: absolute;
            width: 2px;
            background: linear-gradient(to top, #00ffff, rgba(0, 255, 255, 0.3));
            height: 0%;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0.7;
            display: none;
            z-index: 6;
            pointer-events: none;
        }
        
        /* Parçacık */
        .energy-particle {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #00ffff;
            box-shadow: 0 0 10px #00ffff, 0 0 15px #00ffff;
            left: 50%;
            transform: translate(-50%, 0%) scale(0);
            opacity: 0;
            z-index: 7;
            pointer-events: none;
        }
        
        /* Animasyon sınıfları */
        .animate-pulse {
            animation: stage1-pulse 0.5s ease-in-out;
        }
        
        .animate-energy-flow {
            display: block;
            animation: energy-flow 0.8s ease-out forwards;
        }
        
        .animate-particle {
            animation: particle-flow 0.8s ease-out forwards;
            opacity: 1;
            transform: translate(-50%, 0%) scale(1);
        }
        
        .animate-box-glow {
            animation: top-box-glow 0.8s ease-out;
        }
        
        .animate-char-color {
            animation: char-color-change 0.3s ease-out forwards;
        }
        
        /* İç ışık yansıması */
        .inner-glow {
            box-shadow: inset 0 0 15px #00ffff;
        }
        
        /* Işıma efekti */
        .box-highlight {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            border-radius: 6px;
            background-color: rgba(0, 255, 255, 0.2);
            opacity: 0;
            z-index: 2;
            pointer-events: none;
        }
        
        /* Tam ekran butonu için "nefes alma" animasyonu */
        @keyframes fullscreen-button-pulse {
            0% { box-shadow: 0 0 0 0 rgba(51, 255, 51, 0.4); }
            50% { box-shadow: 0 0 0 5px rgba(51, 255, 51, 0.1); }
            100% { box-shadow: 0 0 0 0 rgba(51, 255, 51, 0.4); }
        }
        
        /* Tam ekran butonu için simge geçiş efekti */
        #in-game-fullscreen svg {
            transition: transform 0.3s ease;
        }
        
        #in-game-fullscreen:hover svg {
            transform: scale(1.1);
        }
        
        /* Tam ekran butonu için simge değişimi animasyonu */
        #in-game-fullscreen svg {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- Ses Kontrolü Butonu -->
    <div id="sound-control" style="position: fixed; top: 15px; right: 15px; z-index: 1000; cursor: pointer;">
        <svg id="sound-on" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#33ff33" stroke-width="2" style="display: block;">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
            <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
        </svg>
        <svg id="sound-off" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ff3333" stroke-width="2" style="display: none;">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            <line x1="23" y1="9" x2="17" y2="15"></line>
            <line x1="17" y1="9" x2="23" y2="15"></line>
        </svg>
    </div>

    <!-- Ses Dosyaları Konteyneri -->
    <div id="sound-system" style="display: none;">
        <!-- Ses dosyaları burada preload edilecek -->
    </div>

    <!-- Başlangıç Ekranı -->
    <div id="start-screen" class="screen">
        <div class="scrollable">
            <h1 style="color: #33ff33; margin-bottom: 20px; font-size: 2.5rem; text-shadow: 0 0 10px rgba(51, 255, 51, 0.5);">CSI: CodeBreaker</h1>
            <p style="margin-bottom: 15px; font-size: 1.3rem;">Gizlenmiş klasörlere erişebilmek için cihazın güvenlik duvarını manipüle et ve şifreyi deşifre et.</p>
            
            <!-- Oyun Talimatları -->
            <div style="background-color: rgba(0, 0, 0, 0.5); border: 2px solid #33ff33; padding: 20px; border-radius: 8px; margin-bottom: 25px; max-width: 600px; text-align: left;">
                <h3 style="color: #33ff33; margin-bottom: 15px; text-align: center;">GÖREV TALİMATLARI</h3>
                
                <div style="margin-bottom: 15px;">
                    <h4 style="color: #ffff00; margin-bottom: 5px;">AŞAMA 1 (Kripto Anahtarlarını Ortaya Çıkar):</h4>
                    <ul style="list-style-type: none; padding-left: 15px;">
                        <li style="margin-bottom: 5px;">1. CONNECT ile güvenlik bağlantısını kur</li>
                        <li style="margin-bottom: 5px;">2. Döngü durduğunda, sinyal veren kilidin altındaki iki monitörden birini seç</li>
                        <li style="margin-bottom: 5px;">3. Seçim doğruysa, kripto anahtarı üstteki monitöre kaydedilir</li>
                        <li style="margin-bottom: 5px;">4. Yanlış seçimde döngü otomatik başlar; tekrar CONNECT ile bağlantı ara</li>
                        <li style="margin-bottom: 5px;">5. 9 kripto anahtarı elde edildiğinde sistem 2. aşamaya geçer</li>
                    </ul>
                </div>
                
                <div>
                    <h4 style="color: #00ffff; margin-bottom: 5px;">AŞAMA 2 (Kripto Karakterlerini Eşle):</h4>
                    <ul style="list-style-type: none; padding-left: 15px;">
                        <li style="margin-bottom: 5px;">1. Alt monitörlerden birine dokunarak monitörü aktif et</li>
                        <li style="margin-bottom: 5px;">2. Doğru karakter eşleştiği anda tekrar dokunarak senkronizasyon sağla</li>
                        <li style="margin-bottom: 5px;">3. BAĞLAN butonu ile eşleşmeyi kontrol et</li>
                        <li style="margin-bottom: 5px;">4. Tüm 9 senkronizasyon tamamlandığında kripto şifre kırılır</li>
                    </ul>
                </div>
            </div>
            
            <!-- Yatay ekran uyarısı -->
            <div id="orientation-warning" style="background-color: rgba(255, 153, 0, 0.2); border: 2px solid #ff9900; padding: 15px; border-radius: 8px; margin-bottom: 25px; display: none;">
                <p style="color: #ff9900; font-size: 1.3rem; margin: 0;"><strong>⚠️ Önemli:</strong> En iyi deneyim için cihazınızı yatay konumda kullanınız!</p>
            </div>

            <!-- Tam Ekran Modu İçin Buton -->
            <button id="fullscreen-btn" class="btn" style="margin-bottom: 20px;" onclick="requestFullScreen()">
                <svg style="width: 20px; height: 20px; margin-right: 8px; vertical-align: bottom;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
                </svg>
                TAM EKRAN MODU
            </button>
        </div>
        <button id="start-btn" class="btn" onclick="startGame()">GÖREVİ BAŞLAT</button>
    </div>

    <!-- Oyun Alanı -->
    <!-- <h1 class="title">CSI Kod Kırma Operasyonu</h1> --> <!-- Başlık kaldırıldı -->
    <div class="game-container">
        <!-- Tam ekran butonu - Oyun içi -->
        <div id="in-game-fullscreen" style="position: absolute; top: 15px; left: 15px; cursor: pointer; z-index: 100; width: 30px; height: 30px; background-color: rgba(0, 0, 0, 0.5); border-radius: 5px; display: flex; justify-content: center; align-items: center; animation: fullscreen-button-pulse 2s infinite;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#33ff33" stroke-width="2">
                <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
            </svg>
        </div>
        
        <!-- Aşama göstergesi -->
        <div class="stage-indicator" id="stage-indicator">AŞAMA 1/2</div>
        <div class="timer">60</div>
        
        <!-- Kilit İkonu Container - Bağlantı çizgileri arasındaki kilit ikonları -->
        <div id="lock-container"></div>
        
        <div class="shield" id="shield"></div>
        
        <!-- Password Row - üst sıra -->
        <div class="password-row" id="password-row">
            <!-- 9 kutu JavaScript ile eklenecek -->
        </div>
        
        <!-- Code Row - alt sıra -->
        <div class="code-row" id="code-row">
            <!-- 9 kutu JavaScript ile eklenecek -->
        </div>
        
        <!-- Kontrol Butonları -->
        <div class="controls">
            <button id="connect-btn" class="btn">CONNECT</button>
        </div>
    </div>
    
    <!-- Aşama Tamamlandı Ekranı -->
    <div id="stage-complete" class="screen hidden">
        <h2 style="color: #33ff33; margin-bottom: 20px; font-size: 2.2rem;">KRİPTO DEŞİFRE ANAHTARI ONAYLANDI</h2>
        <p style="margin-bottom: 25px; font-size: 1.3rem;">Şifre eşleştirmesi ekranı hazır.</p>
        <button id="next-stage-btn" class="btn" onclick="startStage2()">2. AŞAMAYA GEÇ</button>
    </div>
    
    <!-- Oyun Sonu Ekranı -->
    <div id="win-screen" class="screen hidden">
        <h2 style="color: #33ff33; margin-bottom: 20px; font-size: 2.2rem;">AES-256 KRİPTO KORUMALI VERİ DEŞİFRE EDİLDİ</h2>
        <p style="margin-bottom: 15px; font-size: 1.5rem; color: #ffff00;">ŞİFRE: E-A-Y-D-I-N-1-2-3</p>
        <div style="background: #111; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <p id="clue" style="color: #ff9900; font-size: 1.3rem;">Kurtarılan Dosya: <a href="https://raw.githubusercontent.com/MonEuphorian/eaydinpc/refs/heads/main/assets/nk2.jpg" target="_blank" style="color: #ff9900; text-decoration: underline;">https://raw.githubusercontent.com/MonEuphorian/eaydinpc/refs/heads/main/assets/nk2.jpg</a></p>
        </div>
        <button id="restart-btn" class="btn" onclick="initGame(); winScreen.classList.add('hidden');">YENİDEN BAŞLAT</button>
    </div>
    
    <!-- Süre Doldu Ekranı -->
    <div id="time-up" class="screen hidden">
        <h2 style="color: #ff3333; margin-bottom: 20px; font-size: 2.2rem;">SÜRE DOLDU!</h2>
        <p style="margin-bottom: 25px; font-size: 1.3rem;">Güvenlik sistemi tehdidi algıladı ve kendini yeniden başlattı.</p>
        
        <!-- 2. aşamada bilgi gösterecek yer -->
        <p id="retry-message" style="color: #00ffff; margin-bottom: 25px; font-size: 1.3rem; display: none;"></p>
        
        <button id="retry-btn" class="btn" onclick="timeUpScreen.classList.add('hidden'); if(currentStage === 1) { initGame(); } else { startStage2(); }">TEKRAR DENE</button>
    </div>

    <script>
        // Ses sistemi için EventListener'lar ekle
        document.addEventListener('DOMContentLoaded', function() {
            // Sayfa yüklendiğinde ekran yönünü kontrol et
            checkOrientation(false); // İlk başta alert gösterme
            
            // Ekran yönü değiştiğinde otomatik kontrol
            window.addEventListener("orientationchange", function() {
                setTimeout(function() {
                    checkOrientation(false); // Ekran yönü değiştiğinde sessizce güncelle
                }, 300); // Yön değişiminin etkinleşmesi için kısa bir gecikme
            });
            
            // Ekran boyutu değiştiğinde de kontrol et
            window.addEventListener("resize", function() {
                checkOrientation(false);
            });
            
            // Ses kontrol butonuna tıklama olayını ekle
            const soundControl = document.getElementById('sound-control');
            const soundOn = document.getElementById('sound-on');
            const soundOff = document.getElementById('sound-off');
            
            soundControl.addEventListener('click', function() {
                const enabled = SoundSystem.toggleSound();
                if (enabled) {
                    soundOn.style.display = 'block';
                    soundOff.style.display = 'none';
                } else {
                    soundOn.style.display = 'none';
                    soundOff.style.display = 'block';
                }
            });
            
            // Mobil için dokunma olayı
            document.addEventListener('touchstart', function() {
                // İlk dokunuşta sessiz bir ses çal - mobil tarayıcılarda ses API'sini etkinleştirmek için
                SoundSystem.enableAudioContext();
                
                // Mobil cihazlarda tam ekrana geçmeyi dene
                if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                    tryMobileFullscreen();
                }
            }, { once: true });
            
            // Tam ekran butonuna ek olaylar ekle
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            if (fullscreenBtn) {
                fullscreenBtn.addEventListener('click', function(e) {
                    e.preventDefault(); // Form gönderimini engelle
                    
                    // Önce tam ekrana geç
                    requestFullScreen();
                    
                    // Sonra ekran yönünü kontrol et (bir miktar gecikme ile)
                    setTimeout(function() {
                        // Ekran dikey modda ise uyarı göster, aksi halde gösterme
                        if (window.innerWidth < window.innerHeight) {
                            checkOrientation(false); // false: sessiz uyarı (alert gösterme)
                        }
                    }, 500);
                });
                
                fullscreenBtn.addEventListener('touchend', function(e) {
                    e.preventDefault(); // Çift tıklama önleme
                    
                    // Önce tam ekrana geç
                    requestFullScreen();
                    
                    // Mobil cihazlar için ek tam ekran denemesi
                    if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                        setTimeout(tryMobileFullscreen, 300);
                        
                        // Sonra ekran yönünü kontrol et
                        setTimeout(function() {
                            if (window.innerWidth < window.innerHeight) {
                                checkOrientation(false);
                            }
                        }, 500);
                    }
                });
            }

            // Mobil cihazlar için adres çubuğunu gizleme denemesi
            setTimeout(function() {
                // iOS/Android için adres çubuğunu gizlemeye yardımcı olur
                window.scrollTo(0, 1);
                
                // Bazı mobil tarayıcılarda ikinci deneme daha etkili
                setTimeout(function() {
                    window.scrollTo(0, 0);
                }, 300);
            }, 300);
            
            // Oyun başladığında ses sistemini başlat
            SoundSystem.init();
            
            // Mobil cihazlarda meta viewport ayarını güncelle
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            if (isMobile) {
                let metaViewport = document.querySelector('meta[name="viewport"]');
                if (metaViewport) {
                    metaViewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui, viewport-fit=cover';
                }
                
                // iOS için apple-mobile-web-app ayarları
                let metaApple = document.querySelector('meta[name="apple-mobile-web-app-capable"]');
                if (!metaApple) {
                    metaApple = document.createElement('meta');
                    metaApple.name = 'apple-mobile-web-app-capable';
                    metaApple.content = 'yes';
                    document.head.appendChild(metaApple);
                }
                
                // Body stil ayarları
                document.body.style.height = '100vh';
                document.body.style.position = 'fixed'; 
                document.body.style.overflow = 'hidden';
            }
        });
        
        // Ses Sistemi - Oyun için ses yönetimi
        const SoundSystem = {
            // Ses dosyalarını hafızada tutan obje
            sounds: {},
            
            // Ses ayarları
            settings: {
                enabled: true,
                volume: 0.5
            },
            
            // Ses dosyalarını yükle
            init: function() {
                const soundFiles = {
                    click: 'assets/sounds/click.mp3',
                    connect: 'assets/sounds/connect.mp3',
                    success: 'assets/sounds/success.mp3', 
                    error: 'assets/sounds/error.mp3',
                    complete: 'assets/sounds/complete.mp3',
                    pulse: 'assets/sounds/pulse.mp3',
                    energy: 'assets/sounds/energy.mp3',
                    particle: 'assets/sounds/particle.mp3',
                    stageComplete: 'assets/sounds/stage_complete.mp3',
                    gameWin: 'assets/sounds/win.mp3',
                    timeUp: 'assets/sounds/time_up.mp3',
                    boxStop: 'assets/sounds/box_stop.mp3'
                };
                
                this.loadSounds(soundFiles);
                this.enableAudioContext();
                
                // Mobile için ses çalma izni
                document.addEventListener('touchstart', () => {
                    this.enableAudioContext();
                }, { once: true });
            },
            
            // Ses dosyalarını yükle - MP3 ve WAV formatlarını destekler
            loadSounds: function(files) {
                const soundSystem = document.getElementById('sound-system');
                
                for (const [name, src] of Object.entries(files)) {
                    // MP3 ve WAV desteği
                    const audio = new Audio();
                    
                    // Her format için kaynak ekle
                    const mp3Src = src.replace('.mp3', '.mp3');
                    const wavSrc = src.replace('.mp3', '.wav');
                    
                    audio.volume = this.settings.volume;
                    
                    // Birden fazla kaynak ekle - tarayıcı desteklediği ilkini çalacak
                    const sourceMP3 = document.createElement('source');
                    sourceMP3.src = mp3Src;
                    sourceMP3.type = 'audio/mpeg';
                    
                    const sourceWAV = document.createElement('source');
                    sourceWAV.src = wavSrc;
                    sourceWAV.type = 'audio/wav';
                    
                    audio.appendChild(sourceMP3);
                    audio.appendChild(sourceWAV);
                    
                    // Preload ekle
                    audio.load();
                    
                    // Sound system'a ekle
                    soundSystem.appendChild(audio);
                    
                    // Objede sakla
                    this.sounds[name] = audio;
                    
                    console.log(`Sound loaded: ${name}`);
                }
            },
            
            // AudioContext'i etkinleştir (mobil için)
            enableAudioContext: function() {
                // Web Audio API için context etkinleştir
                if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    const audioCtx = new AudioContext();
                    
                    // AudioContext'i başlat (mobil için)
                    if (audioCtx.state === 'suspended') {
                        audioCtx.resume();
                    }
                }
            },
            
            // Ses çal
            play: function(name) {
                if (!this.settings.enabled) return;
                
                const sound = this.sounds[name];
                if (sound) {
                    // Sesi başa sar ve çal
                    sound.currentTime = 0;
                    sound.play().catch(error => {
                        console.warn(`Error playing sound ${name}:`, error);
                    });
                }
            },
            
            // Sesleri açıp kapatma
            toggleSound: function(enabled) {
                this.settings.enabled = enabled !== undefined ? enabled : !this.settings.enabled;
                return this.settings.enabled;
            },
            
            // Ses seviyesini ayarla
            setVolume: function(level) {
                this.settings.volume = Math.min(1, Math.max(0, level));
                
                // Tüm ses dosyalarının seviyesini güncelle
                for (const sound of Object.values(this.sounds)) {
                    sound.volume = this.settings.volume;
                }
                
                return this.settings.volume;
            }
        };
        
        // Global Game State - Oyun durumu
        const GameState = {
            // Oyunun mevcut aşaması
            currentStage: 1, // 1: İlk aşama, 2: İkinci aşama
            
            // Süre takibi
            timer: 60,
            timerInterval: null,
            
            // Password (Şifre) satırı
            passwordRow: [],
            
            // Karakter setleri ve dönme durumları
            characterSets: [], 
            spinningIntervals: [],
            isSpinning: true,
            
            // Doğru tahmin edilen kutular
            correctBoxes: [],
            
            // Vurgulanan kutu ve seçimler
            highlightedBoxes: [],
            correctBox: null,
            selectedBox: null,
            
            // Her kutunun durumu
            boxStates: [],
            
            // 2. aşama için özel değişkenler
            boxSpeeds: null,
            charIndices: null,
            
            // Final karakterleri
            finalCharacters: ['E', 'A', 'Y', 'D', 'I', 'N', '1', '2', '3'],
            
            // Game state'i ilk haline getirme
            reset: function() {
                this.currentStage = 1;
                this.timer = 60;
                this.passwordRow = [];
                this.characterSets = [];
                this.spinningIntervals = [];
                this.isSpinning = true;
                this.correctBoxes = [];
                this.highlightedBoxes = [];
                this.correctBox = null;
                this.selectedBox = null;
                this.boxStates = [];
                this.boxSpeeds = null;
                this.charIndices = null;
                
                // Timer'ı temizle
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
            }
        };
        
        // Oyun Değişkenleri - Referans kolaylığı için eski değişken adlarını koruyoruz
        let currentStage = GameState.currentStage; // 1: İlk aşama, 2: İkinci aşama
        let timer = GameState.timer; // Süre (saniye)
        let timerInterval = GameState.timerInterval;
        let passwordRow = GameState.passwordRow; // Şifre satırı
        let characterSets = GameState.characterSets; // Her kutu için olası karakterler
        let spinningIntervals = GameState.spinningIntervals; // Dönen kutuların interval'leri
        let correctBoxes = GameState.correctBoxes; // Doğru tahmin edilen kutular
        let isSpinning = GameState.isSpinning; // Döngü durumu
        let highlightedBoxes = GameState.highlightedBoxes; // Parlayan kutu çifti
        let correctBox = GameState.correctBox; // Doğru kutu
        let selectedBox = GameState.selectedBox; // 2. aşama için seçilen kutu
        let boxStates = GameState.boxStates; // Her kutunun durumu (dönen/duran)
        let boxSpeeds = GameState.boxSpeeds; // Her kutunun dönme hızı (2. aşama için)
        let charIndices = GameState.charIndices; // Her kutunun mevcut karakter indeksi (2. aşama için)
        let finalCharacters = GameState.finalCharacters; // Final animasyonu için karakterler
        
        // DOM Elementleri
        const passwordRowEl = document.getElementById('password-row');
        const codeRowEl = document.getElementById('code-row');
        const timerEl = document.querySelector('.timer');
        const shieldEl = document.getElementById('shield');
        const connectBtn = document.getElementById('connect-btn');
        const stageIndicator = document.getElementById('stage-indicator');
        
        // Ekran elementleri
        const startScreen = document.getElementById('start-screen');
        const stageCompleteScreen = document.getElementById('stage-complete');
        const winScreen = document.getElementById('win-screen');
        const timeUpScreen = document.getElementById('time-up');
        
        // Butonlar
        const startBtn = document.getElementById('start-btn');
        const nextStageBtn = document.getElementById('next-stage-btn');
        const restartBtn = document.getElementById('restart-btn');
        const retryBtn = document.getElementById('retry-btn');
        
        // Olası karakterler
        const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        const lettersOnly = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        const numbersOnly = '0123456789';
        
        // Tam ekran moduna geçiş için fonksiyon
        function requestFullScreen() {
            const docEl = document.documentElement;
            
            // Farklı tarayıcılar için tam ekran API desteği
            const requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen ||
                          docEl.webkitRequestFullscreen || docEl.msRequestFullscreen;
            
            // Ekran kilitleme API'si (mobil cihazlar için)
            const lockOrientation = screen.lockOrientation || screen.mozLockOrientation ||
                         screen.msLockOrientation || (screen.orientation && screen.orientation.lock);
            
            // Tam ekran moduna geç
            if (requestFullScreen) {
                requestFullScreen.call(docEl)
                    .then(() => {
                        console.log("Fullscreen mode activated");
                        // Yatay ekran modunu kilitlemeyi dene (mobil cihazlar için)
                        if (lockOrientation) {
                            try {
                                lockOrientation("landscape");
                                console.log("Screen orientation locked to landscape");
                            } catch (e) {
                                console.warn("Could not lock screen orientation:", e);
                            }
                        }
                    })
                    .catch(err => {
                        console.warn("Fullscreen request failed:", err);
                        // Başarısız olsa bile oyunu başlat
                        
                        // Mobil için alternatif çözüm
                        tryMobileFullscreen();
                    });
            } else {
                // Tam ekran API'si desteklenmiyorsa alternatif çözüm dene
                tryMobileFullscreen();
            }

            // iOS Safari için viewport tam ekran çözümü
            setTimeout(() => {
                window.scrollTo(0, 1); // Adres çubuğunu gizlemeye yardımcı olur
            }, 300);
        }

        // Mobil cihazlar için alternatif tam ekran çözümü
        function tryMobileFullscreen() {
            // Mobil cihazlar için meta viewport ayarı güncelle
            let metaViewport = document.querySelector('meta[name="viewport"]');
            if (metaViewport) {
                metaViewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui, viewport-fit=cover';
            }
            
            // iOS için özel tam ekran çözümü
            if (navigator.userAgent.match(/iPhone|iPad|iPod/i)) {
                // iOS için body'yi tam ekran yap
                document.body.style.height = '100vh';
                document.body.style.width = '100vw';
                document.body.style.position = 'fixed';
                
                // Safari'de adres çubuğunu gizleme denemesi
                setTimeout(function() {
                    window.scrollTo(0, 1);
                    // Sonra tekrar dene
                    setTimeout(function() {
                        window.scrollTo(0, 0);
                    }, 100);
                }, 100);
            }
            
            // Android için özel tam ekran çözümü
            if (navigator.userAgent.match(/Android/i)) {
                // Android için body stil ayarları
                document.body.style.height = '100%';
                document.body.style.overflow = 'hidden';
                
                // Chrome adres çubuğunu gizleme denemesi
                window.scrollTo(0, 1);
            }
        }

        // Oyunu başlat
        function startGame() {
            startScreen.classList.add('hidden');
            // Ses sistemini başlat
            SoundSystem.init();
            // Başlangıç sesi
            SoundSystem.play('connect');

            // Tam ekran moduna geç
            requestFullScreen();
            
            // Mobil cihazlar için ek kontrol
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            if (isMobile) {
                // İkinci bir deneme - bazı mobil tarayıcılar ilk denemede tam ekran izni vermeyebilir
                setTimeout(() => {
                    tryMobileFullscreen();
                }, 1000);
            }
            
            initGame();
        }

        // Tam ekrandan çıkış için fonksiyon (kullanıcı oyun içinde çıkmak isterse)
        function exitFullScreen() {
            const exitFullscreen = document.exitFullscreen || document.mozCancelFullScreen ||
                       document.webkitExitFullscreen || document.msExitFullscreen;
            
            if (exitFullscreen) {
                if (document.fullscreenElement || document.mozFullScreenElement ||
                    document.webkitFullscreenElement || document.msFullscreenElement) {
                    exitFullscreen.call(document);
                }
            }
        }

        // Tam ekran değişikliklerini izle
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
        document.addEventListener('MSFullscreenChange', handleFullscreenChange);

        // Tam ekran değiştiğinde çağrılacak
        function handleFullscreenChange() {
            // Tam ekran durumunu güncelledikten sonra simgeyi değiştir
            updateFullscreenButtonIcon();
            
            if (!isFullScreen()) {
                console.log("Fullscreen mode exited");
            } else {
                console.log("Fullscreen mode entered");
            }
        }
        
        // Pencere yüklendiğinde ve yeniden boyutlandığında çağrılacak
        function handleResize() {
            checkOrientation();
            updateConnectorLines();
            
            // Kilit ikonlarını yeniden konumlandır
            if (currentStage === 1) {
                createLockIcons();
            }
        }
        
        // Oyunu başlat
        function initGame() {
            // Game state'i sıfırla
            GameState.reset();
            currentStage = GameState.currentStage;
            
            // Aşama göstergesini güncelle
            stageIndicator.textContent = "AŞAMA 1/2";
            
            // Password row oluştur (üst sıra)
            passwordRowEl.innerHTML = '';
            for (let i = 0; i < 9; i++) {
                const box = document.createElement('div');
                box.className = 'box password-box';
                box.textContent = '?';
                passwordRowEl.appendChild(box);
            }
            
            // Code row oluştur (alt sıra)
            codeRowEl.innerHTML = '';
            for (let i = 0; i < 9; i++) {
                const box = document.createElement('div');
                box.className = 'box spinning';
                box.innerHTML = '<div class="spinner">?</div>';
                box.dataset.index = i; // Tıklama için indeks ekle
                
                // Kutuya tıklama olayı ekle
                box.addEventListener('click', function() {
                    handleBoxClick(i);
                });
                
                codeRowEl.appendChild(box);
            }
            
            // Her kutu için rastgele karakter seti oluştur
            GameState.characterSets = [];
            characterSets = GameState.characterSets;
            
            for (let i = 0; i < 9; i++) {
                // Her kutu için olası karakterleri karıştır
                GameState.characterSets.push(shuffleString(characters));
                characterSets = GameState.characterSets;
            }
            
            // Doğru şifre oluştur (rastgele)
            GameState.passwordRow = [];
            passwordRow = GameState.passwordRow;
            
            for (let i = 0; i < 9; i++) {
                const randomIndex = Math.floor(Math.random() * characters.length);
                GameState.passwordRow.push(characters[randomIndex]);
                passwordRow = GameState.passwordRow;
            }
            
            // Kutular için spinning efekti başlat
            startSpinning();
            
            // İlk aşama için süreyi ayarla
            GameState.timer = 60;
            timer = GameState.timer;
            updateTimer();
            
            // Timer'ı başlat
            clearInterval(GameState.timerInterval);
            GameState.timerInterval = setInterval(updateTimer, 1000);
            timerInterval = GameState.timerInterval;
            
            // Doğru kutuların sayısını sıfırla
            GameState.correctBoxes = [];
            correctBoxes = GameState.correctBoxes;
            
            // Durum değişkenlerini sıfırla
            GameState.isSpinning = true;
            isSpinning = GameState.isSpinning;
            GameState.highlightedBoxes = [];
            highlightedBoxes = GameState.highlightedBoxes;
            GameState.correctBox = null;
            correctBox = GameState.correctBox;
            
            // Timer rengini başlangıçta yeşil yap
            timerEl.style.color = '#33ff33';
            timerEl.style.animation = '';
            
            // Connect butonunu güncelle
            updateConnectButton();
            
            // Shield'ı gizle
            shieldEl.style.display = 'none';
            
            // Bağlantı çizgilerini güncelle
            setTimeout(updateConnectorLines, 100);
            
            // Kilit ikonlarını oluştur
            setTimeout(createLockIcons, 100);
            
            console.log("Oyun sıfırlandı ve başlatıldı - Aşama 1");
        }
        
        // Kutulardaki karakterleri döndürme efekti
        function startSpinning() {
            console.log("Starting spinning effect for stage:", GameState.currentStage);
            
            // Önceki interval'leri temizle
            if (GameState.spinningIntervals && GameState.spinningIntervals.length > 0) {
                GameState.spinningIntervals.forEach((interval, index) => {
                    if (interval) {
                        clearInterval(interval);
                    }
                });
            }
            
            // Interval'leri sıfırla
            GameState.spinningIntervals = [];
            spinningIntervals = GameState.spinningIntervals;
            
            const codeBoxes = codeRowEl.querySelectorAll('.box');
            
            // Aşama 1'de tüm kutularda tüm karakterler döner
            if (GameState.currentStage === 1) {
                console.log("Setting up stage 1 spinning boxes");
                // Tüm kutular için aynı hızı kullan
                const speed = 150; // Aşama 1 için sabit hız
                
                codeBoxes.forEach((box, index) => {
                    const spinner = box.querySelector('.spinner');
                    let charIndex = 0;
                    
                    const interval = setInterval(() => {
                        charIndex = (charIndex + 1) % GameState.characterSets[index].length;
                        spinner.textContent = GameState.characterSets[index][charIndex];
                    }, speed);
                    
                    GameState.spinningIntervals.push(interval);
                    spinningIntervals = GameState.spinningIntervals;
                    
                    GameState.boxStates[index] = true; // true = dönen
                    boxStates = GameState.boxStates;
                });
            } 
            // Aşama 2'de üst kutudaki karaktere göre döner
            else {
                console.log("Setting up stage 2 spinning boxes");
                // 2. aşama için hız değerleri (kutu bazında saklanacak)
                if (!GameState.boxSpeeds) {
                    // İlk kez çağrıldığında hız değerlerini oluştur
                    GameState.boxSpeeds = [];
                    boxSpeeds = GameState.boxSpeeds;
                    
                    for (let i = 0; i < 9; i++) {
                        GameState.boxSpeeds[i] = 100 + Math.random() * 100; // 100-200 ms arası
                        boxSpeeds[i] = GameState.boxSpeeds[i];
                    }
                }
                
                // Mevcut karakter indeksleri (kaldığı yerden devam için)
                if (!GameState.charIndices) {
                    GameState.charIndices = Array(9).fill(0);
                    charIndices = GameState.charIndices;
                }
                
                // Her kutu için ayrı bir interval oluştur ve spesifik indekse ata
                GameState.spinningIntervals = new Array(9).fill(null);
                spinningIntervals = GameState.spinningIntervals;
                GameState.boxStates = new Array(9).fill(true);
                boxStates = GameState.boxStates;
                
                // Seçili kutuyu sıfırla
                GameState.selectedBox = null;
                selectedBox = null;
                
                codeBoxes.forEach((box, index) => {
                    // Tüm seçim stillerini kaldır
                    box.classList.remove('selected');
                    
                    // Bu kutu çözülmüş mü kontrol et
                    if (GameState.correctBoxes.includes(index)) {
                        console.log("Box", index, "is already solved, not spinning");
                        box.classList.add('solved');
                        GameState.boxStates[index] = false; // çözülmüş kutu dönmez
                        boxStates = GameState.boxStates;
                        return; // Çözülmüşse döngüye katma
                    }
                    
                    // Kutu için döngüyü başlat
                    startBoxSpinning(index);
                });
            }
            
            GameState.isSpinning = true;
            isSpinning = GameState.isSpinning;
            
            updateConnectButton();
        }
        
        // Timer'ı güncelleme
        function updateTimer() {
            if (timer > 0) {
                timer--;
                timerEl.textContent = timer;
                
                // Son 10 saniye kırmızı yanıp sönsün, öncesinde yeşil kalsın
                if (timer <= 10) {
                    timerEl.style.color = '#ff3333'; // Kırmızı
                    timerEl.style.animation = 'blink 1s infinite';
                } else {
                    timerEl.style.color = '#33ff33'; // Yeşil
                    timerEl.style.animation = '';
                }
            } else {
                clearInterval(timerInterval);
                timeUp();
            }
        }
        
        // Süre dolduğunda
        function timeUp() {
            // Döngüleri durdur
            stopSpinning();
            
            // Süre doldu sesi çal
            SoundSystem.play('timeUp');
            
            // Süre bitti ekranını göster
            timeUpScreen.classList.remove('hidden');
            
            // Ekrandaki retry butonu için ek bilgi
            if (currentStage === 2) {
                // 2. aşamada zaten çözülmüş kutular varsa göster
                const solvedCount = correctBoxes.length;
                if (solvedCount > 0) {
                    document.getElementById('retry-message').innerHTML = 
                        `${solvedCount} kutu eşleştirildi! Geri kalan kutuları da tamamla.`;
                    document.getElementById('retry-message').style.display = 'block';
                } else {
                    document.getElementById('retry-message').style.display = 'none';
                }
            }
        }
        
        // Tüm dönmeleri durdur
        function stopSpinning() {
            console.log("Stopping all spinning boxes");
            
            // Tüm interval'leri temizle
            if (GameState.spinningIntervals && GameState.spinningIntervals.length > 0) {
                GameState.spinningIntervals.forEach((interval, index) => {
                    if (interval) {
                        clearInterval(interval);
                        console.log("Cleared interval at index", index);
                    }
                });
            }
            
            // Interval'leri sıfırla
            GameState.spinningIntervals = new Array(9).fill(null);
            spinningIntervals = new Array(9).fill(null);
            
            // Döngü durumunu güncelle
            GameState.isSpinning = false;
            isSpinning = false;
        }
        
        // Kutuya tıklama işleyicisi
        function handleBoxClick(index) {
            // 1. aşamada sadece döngü durduğunda tepki versin
            if (currentStage === 1) {
                console.log("Stage 1 box click:", index, "isSpinning:", isSpinning, "highlightedBoxes:", highlightedBoxes, "correctBox:", correctBox);
                // Sadece döngü durdurulmuşsa tıklamayı işle
                if (!isSpinning && highlightedBoxes.includes(index)) {
                    const codeBoxes = codeRowEl.querySelectorAll('.box');
                    const passwordBoxes = passwordRowEl.querySelectorAll('.box');
                    
                    // Eğer bu kutu zaten çözülmüşse, işlemi atlayalım
                    if (GameState.correctBoxes.includes(index)) {
                        console.log("Box already solved, ignoring click:", index);
                        return;
                    }
                    
                    if (index === correctBox) {
                        console.log("Correct box selected:", index);
                        // Doğru kutu seçildi
                        
                        // Başarı sesi çal
                        SoundSystem.play('success');
                        
                        // Seçili kutunun o anki değerini al
                        const currentChar = codeBoxes[index].querySelector('.spinner').textContent;
                        
                        // Password kutusuna ata
                        passwordBoxes[index].textContent = currentChar;
                        
                        // Animasyon sistemini başlat
                        playSuccessAnimation(index, codeBoxes[index], passwordBoxes[index], currentChar);
                        
                        // Doğru kutuları kaydet - ancak sadece yeni eklemeleri yap
                        if (!GameState.correctBoxes.includes(index)) {
                            GameState.correctBoxes.push(index);
                            correctBoxes = GameState.correctBoxes;
                            
                            console.log("Updated correctBoxes array:", correctBoxes);
                        }
                        
                        // Kilit ikonlarının durumunu güncelle
                        updateLockIconStates();
                        
                        // Tüm kutular doğru mu kontrol et
                        if (correctBoxes.length === 9) {
                            setTimeout(() => {
                                SoundSystem.play('complete');
                                playCompletionAnimation();
                            }, 1000); // Animasyon tamamlandıktan sonra
                            return; // Oyun tamamlandı, fonksiyondan çık
                        }
                    } else {
                        console.log("Wrong box selected:", index, "correctBox was:", correctBox);
                        // Yanlış kutu seçildi
                        
                        // Hata sesi çal
                        SoundSystem.play('error');
                        
                        // Hata animasyonu - kısa süreli kırmızı yanıp sönme
                        codeBoxes[index].classList.add('error');
                        
                        setTimeout(() => {
                            // Kısa süre sonra hata stilini kaldır
                            codeBoxes[index].classList.remove('error');
                            
                            // Parlayan kutuları temizle
                            clearHighlightedBoxes();
                            
                            // Döngüyü yeniden başlat (otomatik)
                            startSpinning();
                            updateConnectButton();
                        }, 200); // 0.2 saniye hata gösterimi
                    }
                }
            } else if (currentStage === 2) {
                // Aşama 2 için doğrudan toggleBoxSpinning fonksiyonunu çağır
                toggleBoxSpinning(index);
            }
        }
        
        // YENİ: Başarılı doğru seçim animasyonunu oynat (Aşama 1)
        function playSuccessAnimation(index, bottomBox, topBox, character) {
            // Animasyon sırasında tüm tıklamaları engelle
            document.body.style.pointerEvents = 'none';
            
            // Alt kutu için pulse animasyonu
            bottomBox.classList.add('animate-pulse');
            bottomBox.classList.add('success');
            
            // Pulse sesi çal
            SoundSystem.play('pulse');
            
            // Kutu arasına enerji çizgisi ekle
            createEnergyFlow(index, bottomBox, topBox);
            
            // Üst kutu için zamanlama
            setTimeout(() => {
                // Üst kutuya parlaklık ekle ve karakteri değiştir
                topBox.classList.add('animate-box-glow');
                topBox.classList.add('solved');
                
                // Parçacık sesi çal
                SoundSystem.play('particle');
                
                // İç ışıma efekti
                const boxHighlight = document.createElement('div');
                boxHighlight.className = 'box-highlight';
                topBox.appendChild(boxHighlight);
                
                // Highlight efektini göster ve kaybol
                boxHighlight.style.opacity = '0.8';
                setTimeout(() => {
                    boxHighlight.style.opacity = '0';
                    setTimeout(() => {
                        if (boxHighlight.parentNode === topBox) {
                            topBox.removeChild(boxHighlight);
                        }
                    }, 300);
                }, 300);
                
                // 1 saniye sonra tüm animasyonları temizle
                setTimeout(() => {
                    // Tüm animasyon sınıflarını temizle
                    bottomBox.classList.remove('animate-pulse', 'success');
                    topBox.classList.remove('animate-box-glow');
                    
                    // Tıklamaları geri aç
                    document.body.style.pointerEvents = 'auto';
                    
                    // Enerji animasyonlarını temizle
                    const energyContainer = document.querySelector(`.energy-container-${index}`);
                    if (energyContainer) {
                        energyContainer.remove();
                    }
                }, 800);
            }, 400); // Üst kutu animasyonu için gecikme
        }
        
        // YENİ: Enerji akışı animasyonu oluştur
        function createEnergyFlow(index, bottomBox, topBox) {
            // Kutular arasındaki bağlantıyı hesapla
            const bottomRect = bottomBox.getBoundingClientRect();
            const topRect = topBox.getBoundingClientRect();
            
            // Enerji akışı için konteynır oluştur
            const energyContainer = document.createElement('div');
            energyContainer.className = `energy-flow-container energy-container-${index}`;
            document.body.appendChild(energyContainer);
            
            // Enerji çizgisi oluştur
            const energyLine = document.createElement('div');
            energyLine.className = 'energy-line';
            
            // Konumunu hesapla
            const startX = bottomRect.left + bottomRect.width / 2;
            const startY = bottomRect.top;
            const endY = topRect.bottom;
            const lineHeight = startY - endY;
            
            // Stil uygula
            energyLine.style.left = `${startX}px`;
            energyLine.style.top = `${endY}px`;
            energyLine.style.height = '0%';
            energyLine.style.maxHeight = `${lineHeight}px`;
            
            energyContainer.appendChild(energyLine);
            
            // Parçacık oluştur
            const particle = document.createElement('div');
            particle.className = 'energy-particle';
            
            // Parçacık konumunu ayarla - ALT KUTUDAN BAŞLAMALI
            particle.style.left = `${startX}px`;
            particle.style.top = `${bottomRect.top}px`; // Alt kutunun üst kenarından başla
            
            energyContainer.appendChild(particle);
            
            // Enerji sesi çal
            SoundSystem.play('energy');
            
            // Animasyonları başlat
            requestAnimationFrame(() => {
                energyLine.classList.add('animate-energy-flow');
                
                // Parçacık animasyonu için kısa gecikme
                setTimeout(() => {
                    particle.classList.add('animate-particle');
                    
                    // Animasyon: Alt kutudan üst kutuya hareket
                    particle.style.transition = 'top 0.8s ease-out';
                    particle.style.top = `${endY}px`; // Üst kutunun alt kenarına git
                }, 100);
            });
        }
        
        // Özel tamamlanma animasyonu
        function playCompletionAnimation() {
            // Tüm döngüleri durdur
            stopSpinning();
            
            // Timer'ı hemen durdur
            clearInterval(timerInterval);
            timer = 1; // Zamanlayıcıyı 1'e ayarla ki zamanlayıcı güncellemesi yeniden çalışırsa bile süre sıfırlanmadan önce oyun tamamlansın
            timerEl.textContent = timer;
            
            // Üst kutularda dalgalanma efekti
            const passwordBoxes = passwordRowEl.querySelectorAll('.box');
            passwordBoxes.forEach(box => {
                box.style.animation = 'pulse 0.5s infinite alternate';
            });
            
            // 3 saniye sonra tamamlanma ekranını göster
            setTimeout(() => {
                stageComplete();
            }, 3000);
        }
        
        // String'i karıştır
        function shuffleString(str) {
            const array = str.split('');
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array.join('');
        }
        
        // Birinci aşama tamamlandı
        function stageComplete() {
            clearInterval(timerInterval);
            // Aşama tamamlandı sesi çal
            SoundSystem.play('stageComplete');
            stageCompleteScreen.classList.remove('hidden');
            stopSpinning();
            
            // 1. aşamadayken üst satırdaki karakterleri kaydet, böylece 2. aşamaya aktarılsın
            if (currentStage === 1) {
                // Mevcut karakterleri al
                const passwordBoxes = passwordRowEl.querySelectorAll('.box');
                GameState.passwordRow = [];
                passwordRow = [];
                
                // Karakterleri kaydet
                for (let i = 0; i < 9; i++) {
                    const boxValue = passwordBoxes[i].textContent;
                    GameState.passwordRow.push(boxValue);
                    passwordRow.push(boxValue);
                }
            }
        }
        
        // İkinci aşamayı başlat
        function startStage2() {
            console.log("Starting Stage 2...");
            
            // Aşama değişim sesi çal
            SoundSystem.play('connect');
            
            // Tüm interval ve animasyonları temizle
            stopSpinning();
            clearAllAnimations();
            
            // Aşama durumunu güncelle
            GameState.currentStage = 2;
            currentStage = 2;
            
            // Aşama 1 tamamlandı ekranını gizle
            stageCompleteScreen.classList.add('hidden');
            
            // Kilit ikonlarını gizle (Aşama 2'de gösterilmeyecek)
            const lockIcons = document.querySelectorAll('.lock-icon');
            lockIcons.forEach(icon => {
                icon.classList.remove('active');
            });
            
            // Aşama göstergesini güncelle
            stageIndicator.textContent = "AŞAMA 2/2";
            
            // Password row değerlerini koru
            const passwordBoxes = passwordRowEl.querySelectorAll('.box');
            const codeBoxes = codeRowEl.querySelectorAll('.box');
            
            // Aşama 2 için durumu temizle
            GameState.correctBoxes = [];
            GameState.passwordRow = [];
            correctBoxes = [];
            passwordRow = [];
            
            // Üst sıradaki kutuların değerlerini al ve stillerini ayarla
            for (let i = 0; i < 9; i++) {
                // Üst kutulardaki değerleri kaydet
                const boxValue = passwordBoxes[i].textContent;
                GameState.passwordRow.push(boxValue);
                passwordRow.push(boxValue);
                
                // Tüm kutuların animasyonlarını ve stillerini temizle
                codeBoxes[i].classList.remove('solved', 'success', 'selected', 'error', 'highlight', 'glitch-effect');
                passwordBoxes[i].classList.remove('success', 'error', 'highlight', 'glitch-effect', 'temp-highlight');
                codeBoxes[i].style.animation = '';
                passwordBoxes[i].style.animation = '';
                
                // Password kutularını solved stilinde göster
                passwordBoxes[i].classList.add('solved');
            }
            
            // 2. aşama için değişkenleri hazırla
            GameState.boxSpeeds = [];
            GameState.charIndices = Array(9).fill(0);
            boxSpeeds = GameState.boxSpeeds;
            charIndices = GameState.charIndices;
            
            // Önceki interval'leri temizle
            stopSpinning();
            GameState.spinningIntervals = new Array(9).fill(null);
            spinningIntervals = GameState.spinningIntervals;
            
            // Her kutu için sabit bir hız belirle
            for (let i = 0; i < 9; i++) {
                GameState.boxSpeeds[i] = 100 + Math.random() * 100; // 100-200 ms arası
                boxSpeeds[i] = GameState.boxSpeeds[i];
            }
            
            // Connect butonunun metnini değiştir
            connectBtn.textContent = 'BAĞLAN';
            connectBtn.classList.add('connect-stage2');
            connectBtn.classList.remove('btn-active');
            
            // Timer'ı sıfırla ve yeniden başlat
            GameState.timer = 90;
            timer = GameState.timer;
            timerEl.textContent = timer;
            timerEl.style.animation = '';
            timerEl.style.color = '#33ff33'; // Yeşil renk başlangıçta
            
            // Timer'ı başlat
            clearInterval(GameState.timerInterval);
            GameState.timerInterval = setInterval(updateTimer, 1000);
            timerInterval = GameState.timerInterval;
            
            // Kutu durumlarını sıfırla
            GameState.boxStates = Array(9).fill(true); // Başlangıçta tüm kutular döner
            boxStates = GameState.boxStates;
            
            // Seçili kutuyu sıfırla
            GameState.selectedBox = null;
            selectedBox = null;
            
            // Döndürmeyi yeniden başlat
            startSpinning();
            
            // Durum değişkenlerini sıfırla
            GameState.isSpinning = true;
            isSpinning = true;
            GameState.highlightedBoxes = [];
            highlightedBoxes = [];
            
            // Connect butonunu güncelle
            updateConnectButton();
            
            // Bağlantı çizgilerini güncelle
            setTimeout(updateConnectorLines, 100);
            
            console.log("Stage 2 initialized successfully");
        }

        // Tüm animasyonları temizle
        function clearAllAnimations() {
            console.log("Clearing all animations");
            // Tüm kutuların animasyonlarını temizle
            const allBoxes = document.querySelectorAll('.box');
            allBoxes.forEach(box => {
                box.style.animation = '';
                box.classList.remove('glitch-effect');
            });
            
            // Aşama göstergesi animasyonlarını temizle
            stageIndicator.classList.remove('glitch-effect');
            stageIndicator.style.color = '';
            stageIndicator.style.animation = '';
            
            // Timer animasyonlarını temizle
            timerEl.style.animation = '';
        }
        
        // Oyun kazanıldı
        function winGame() {
            clearInterval(timerInterval);
            // Oyun kazanma sesi çal
            SoundSystem.play('gameWin');
            winScreen.classList.remove('hidden');
            stopSpinning();
        }
        
        // Kutular arası mesafe değişkenini hesapla ve CSS'e ekle
        function updateConnectorLines() {
            const passwordBoxes = document.querySelectorAll('.password-box');
            const codeBoxes = document.querySelectorAll('.code-row .box');
            
            if (passwordBoxes.length > 0 && codeBoxes.length > 0) {
                // İlk üst kutu ve ilk alt kutu arasındaki mesafeyi hesapla
                const passwordBox = passwordBoxes[0].getBoundingClientRect();
                const codeBox = codeBoxes[0].getBoundingClientRect();
                
                // Üst kutunun altından alt kutunun üstüne olan mesafe
                const distance = codeBox.top - passwordBox.bottom;
                
                // Bu mesafeyi CSS değişkeni olarak ekle
                document.documentElement.style.setProperty('--box-spacing', distance + 'px');
                
                // Kilit ikonunun konumunu güncelle
                if (window.matchMedia("(orientation: portrait)").matches) {
                    // Dikey ekranda
                    const lockIcon = document.querySelector('.lock-icon');
                    if (lockIcon) {
                        lockIcon.style.top = `calc(${passwordBox.bottom}px + ${distance/2}px - 18px)`;
                    }
                }
            }
        }
        
        // Kilit ikonlarının durumunu güncelle (çözülmüş kutulara göre)
        function updateLockIconStates() {
            const lockIcons = document.querySelectorAll('.lock-icon');
            
            // Her bir kilit ikonu için kontrol et
            for (let i = 0; i < 8; i++) {
                const lockIcon = lockIcons[i];
                
                // Bu kilit ikonu, i ve i+1 kutularını bağlıyor
                // Eğer her iki kutu da çözülmüşse, kilit ikonu da çözülmüş olarak işaretle
                if (correctBoxes.includes(i) && correctBoxes.includes(i+1)) {
                    lockIcon.classList.remove('highlight');
                    lockIcon.classList.add('solved');
                } 
                // Eğer bu kilit ikonu vurgulanmış ve onunla bağlantılı kutulardan biri seçilmişse
                // vurguyu koru (doğru/yanlış seçim sonrası)
                else if (highlightedBoxes.includes(i) && highlightedBoxes.includes(i+1)) {
                    lockIcon.classList.add('highlight');
                    lockIcon.classList.remove('solved');
                } 
                // Hiçbiri değilse normal görünüm
                else {
                    lockIcon.classList.remove('highlight', 'solved');
                }
            }
        }
        
        // Tek bir kutuyu başlat/durdur (2. aşama için)
        function toggleBoxSpinning(index) {
            console.log("toggleBoxSpinning called for index:", index);
            
            // İşlemleri gerçekleştirmeden önce güvenlik kontrolü
            if (GameState.currentStage !== 2) {
                console.log("Not in stage 2, returning");
                return; // Sadece aşama 2'de çalışmalı
            }
            
            // Tıklama sesi çal
            SoundSystem.play('click');
            
            const codeBoxes = codeRowEl.querySelectorAll('.box');
            const box = codeBoxes[index];
            
            // Bu kutu çözülmüş mü?
            if (GameState.correctBoxes.includes(index)) {
                console.log("Box is already solved, no action taken:", index);
                return; // Çözülmüş kutuyu değiştirme
            }
            
            console.log("Current selectedBox:", GameState.selectedBox, "boxStates:", GameState.boxStates);
            
            // 1. Senaryo: Aynı kutuya tıklanmış - durumunu değiştir (durdur/başlat)
            if (GameState.selectedBox === index) {
                // Kutunun mevcut durumunu tersine çevir
                if (GameState.boxStates[index]) {
                    // Kutu dönüyorsa durdur
                    stopBoxSpinning(index);
                    // Kutu durma sesi çal
                    SoundSystem.play('boxStop');
                } else {
                    // Kutu durmuşsa başlat
                    startBoxSpinning(index);
                    // Tıklama sesi çal
                    SoundSystem.play('click');
                }
            } 
            // 2. Senaryo: Farklı bir kutuya tıklanmış
            else {
                // Önceki seçili kutu varsa, onu temizle
                if (GameState.selectedBox !== null) {
                    // Önceki seçili kutuyu seçimden kaldır
                    resetPreviousBox();
                }
                
                // Yeni kutuyu seçili olarak işaretle
                GameState.selectedBox = index;
                selectedBox = GameState.selectedBox;
                box.classList.add('selected');
                
                // Kutu dönüyorsa durdur, durmuyorsa başlat
                if (GameState.boxStates[index]) {
                    stopBoxSpinning(index);
                    // Kutu durma sesi çal
                    SoundSystem.play('boxStop');
                } else {
                    startBoxSpinning(index);
                    // Tıklama sesi çal
                    SoundSystem.play('click');
                }
            }
            
            // Connect butonunu güncelle
            updateConnectButton();
        }
        
        // Yardımcı fonksiyon - Önceki seçili kutuyu sıfırla
        function resetPreviousBox() {
            if (GameState.selectedBox === null) return;
            
            const codeBoxes = codeRowEl.querySelectorAll('.box');
            const prevBox = codeBoxes[GameState.selectedBox];
            
            // Seçim stilini kaldır
            prevBox.classList.remove('selected');
            
            // Kutu durmuşsa tekrar başlat
            if (!GameState.boxStates[GameState.selectedBox]) {
                startBoxSpinning(GameState.selectedBox);
            }
        }
        
        // Yardımcı fonksiyon - Tek bir kutuyu durdur
        function stopBoxSpinning(index) {
            console.log("Stopping box", index);
            
            const codeBoxes = codeRowEl.querySelectorAll('.box');
            const box = codeBoxes[index];
            
            // Interval'i temizle
            if (GameState.spinningIntervals[index]) {
                clearInterval(GameState.spinningIntervals[index]);
                GameState.spinningIntervals[index] = null;
                spinningIntervals = GameState.spinningIntervals;
            }
            
            // Kutu durumunu güncelle
            GameState.boxStates[index] = false;
            boxStates = GameState.boxStates;
            
            // Görsel seçim belirteci ekle
            box.classList.add('selected');
            
            console.log("Box", index, "stopped successfully");
        }
        
        // Yardımcı fonksiyon - Tek bir kutuyu başlat
        function startBoxSpinning(index) {
            console.log("Starting box", index);
            
            const codeBoxes = codeRowEl.querySelectorAll('.box');
            const box = codeBoxes[index];
            const spinner = box.querySelector('.spinner');
            
            // İlgili karakterleri belirle
            const upperBoxChar = GameState.passwordRow[index];
            let charSet;
            
            if (!isNaN(upperBoxChar)) {
                // Rakam ise
                charSet = numbersOnly;
            } else {
                // Harf ise
                charSet = lettersOnly;
            }
            
            // Mevcut interval'i temizle
            if (GameState.spinningIntervals[index]) {
                clearInterval(GameState.spinningIntervals[index]);
            }
            
            // Döngüyü başlat
            const speed = GameState.boxSpeeds[index];
            const interval = setInterval(() => {
                GameState.charIndices[index] = (GameState.charIndices[index] + 1) % charSet.length;
                charIndices = GameState.charIndices;
                spinner.textContent = charSet[GameState.charIndices[index]];
            }, speed);
            
            // Interval'i kaydet
            GameState.spinningIntervals[index] = interval;
            spinningIntervals[index] = interval;
            
            // Kutu durumunu güncelle
            GameState.boxStates[index] = true;
            boxStates[index] = true;
            
            console.log("Box", index, "started successfully");
        }
        
        // Connect butonunun durumunu güncelle
        function updateConnectButton() {
            if (GameState.currentStage === 1) {
                // Aşama 1 için CONNECT/SEARCH
                if (GameState.isSpinning) {
                    connectBtn.textContent = 'CONNECT';
                    connectBtn.classList.remove('btn-active');
                    connectBtn.classList.remove('connect-stage2');
                } else {
                    connectBtn.textContent = 'SEARCH';
                    connectBtn.classList.add('btn-active');
                    connectBtn.classList.remove('connect-stage2');
                }
            } else {
                // Aşama 2 için BAĞLAN
                connectBtn.textContent = 'BAĞLAN';
                connectBtn.classList.add('connect-stage2');
                
                // Eğer seçili kutu varsa ve durdurulmuşsa butonu aktif yap
                if (GameState.selectedBox !== null && GameState.boxStates[GameState.selectedBox] === false) {
                    connectBtn.classList.add('btn-active');
                } else {
                    connectBtn.classList.remove('btn-active');
                }
            }
        }
        
        // Connect butonu tıklaması
        function handleConnectClick() {
            if (GameState.currentStage === 1) {
                // 1. aşama için yeni mantık
                if (GameState.isSpinning) {
                    // Döngüyü durdur
                    stopSpinning();
                    
                    // Connect sesi çal
                    SoundSystem.play('connect');
                    
                    // Aktif kilit ikonunu seç
                    selectActiveLock();
                    
                    // isSpinning durumunu güncelle
                    GameState.isSpinning = false;
                    isSpinning = false;
                    
                    // Connect butonunu güncelle
                    updateConnectButton();
                } else {
                    // Start butonuna tıklandı - döngüyü yeniden başlat
                    
                    // Parlayan kutuları temizle
                    clearHighlightedBoxes();
                    
                    // Click sesi çal
                    SoundSystem.play('click');
                    
                    // Döngüyü yeniden başlat
                    startSpinning();
                    
                    // isSpinning durumunu güncelle
                    GameState.isSpinning = true;
                    isSpinning = true;
                    
                    // Connect butonunu güncelle
                    updateConnectButton();
                }
            } else {
                // 2. aşama için kutu eşleştirme kontrolü
                SoundSystem.play('click');
                checkStage2Match();
                // Buton durumunu güncelle (eşleşme sonrası)
                updateConnectButton();
            }
        }
        
        // Aktif kilit ikonunu seç
        function selectActiveLock() {
            // Onaylanmamış kilit ikonları için aday listesi oluştur
            const candidates = [];
            
            // Önce doğrudan doğru kutular sayısını kontrol et, 9'dan az ise devam et
            if (GameState.correctBoxes.length === 9) {
                stageComplete();
                return;
            }
            
            console.log("Current correctBoxes before selecting lock:", GameState.correctBoxes);
            
            // Çözülmemiş kutuları bul
            const unsolvedBoxes = [];
            for (let i = 0; i < 9; i++) {
                if (!GameState.correctBoxes.includes(i)) {
                    unsolvedBoxes.push(i);
                }
            }
            
            console.log("Unsolved boxes:", unsolvedBoxes);
            
            // Yan yana çözülmemiş kutular için kilit adayları oluştur
            for (let i = 0; i < 8; i++) {
                // Bir kilit ikonu, iki kutuyu bağlar (i ve i+1)
                // Bu kilit ikonunu seçebilmek için, en az biri çözülmemiş olmalı
                if (!GameState.correctBoxes.includes(i) || !GameState.correctBoxes.includes(i+1)) {
                    // Öncelikle, her iki kutu da çözülmemişse bu kilidi aday göster
                    if (!GameState.correctBoxes.includes(i) && !GameState.correctBoxes.includes(i+1)) {
                        candidates.push({
                            lockIndex: i,
                            priority: 2  // İki kutu da çözülmemiş - yüksek öncelik
                        });
                    } 
                    // Sadece bir kutu çözülmemişse, ikinci öncelik ver
                    else {
                        candidates.push({
                            lockIndex: i,
                            priority: 1  // Bir kutu çözülmüş, diğeri çözülmemiş - düşük öncelik
                        });
                    }
                }
            }
            
            console.log("Lock candidates:", candidates);
            
            // Eğer aday yoksa ama çözülmemiş kutular varsa, son çözülmemiş kutuyu bul
            if (candidates.length === 0 && unsolvedBoxes.length > 0) {
                console.log("No candidates but still have unsolved boxes");
                // Son çözülmemiş kutuyu seç
                const lastUnsolvedIndex = unsolvedBoxes[0];
                
                // Bu kutu ile yan yana olan kutulardan bir tanesini seç
                let neighborIndex;
                if (lastUnsolvedIndex > 0) {
                    neighborIndex = lastUnsolvedIndex - 1;
                } else if (lastUnsolvedIndex < 8) {
                    neighborIndex = lastUnsolvedIndex + 1;
                } else {
                    neighborIndex = 7; // Son çare, eğer 8. kutuysa 7 ile bağla
                }
                
                GameState.highlightedBoxes = [Math.min(lastUnsolvedIndex, neighborIndex), Math.max(lastUnsolvedIndex, neighborIndex)];
                highlightedBoxes = GameState.highlightedBoxes;
                GameState.correctBox = lastUnsolvedIndex; // Çözülmemiş kutuyu doğru olarak işaretle
                correctBox = GameState.correctBox;
                
                console.log("Manually selecting last unsolved box:", lastUnsolvedIndex, "with neighbor:", neighborIndex);
                
                // Sadece kilit ikonunu vurgula, kutuları vurgulama
                highlightLockIcon(true);
                return;
            }
            
            // Adayları önceliğe göre sırala (2 > 1)
            candidates.sort((a, b) => b.priority - a.priority);
            
            // Yüksek öncelikli adaylar arasından rastgele seç
            const highPriorityCandidates = candidates.filter(c => c.priority === candidates[0].priority);
            const randomIndex = Math.floor(Math.random() * highPriorityCandidates.length);
            const activeLockIndex = highPriorityCandidates[randomIndex].lockIndex;
            
            // Bu kilit ikonunun işaret ettiği iki kutu
            GameState.highlightedBoxes = [activeLockIndex, activeLockIndex + 1];
            highlightedBoxes = GameState.highlightedBoxes;
            
            // Kutulardan doğru olanı belirle - sadece çözülmemiş kutuları doğru olarak işaretle
            if (GameState.correctBoxes.includes(activeLockIndex)) {
                // İlk kutu çözülmüşse, ikinci kutu doğrudur (eğer çözülmemişse)
                GameState.correctBox = activeLockIndex + 1;
                correctBox = GameState.correctBox;
            } else if (GameState.correctBoxes.includes(activeLockIndex + 1)) {
                // İkinci kutu çözülmüşse, ilk kutu doğrudur (eğer çözülmemişse)
                GameState.correctBox = activeLockIndex;
                correctBox = GameState.correctBox;
            } else {
                // İkisi de çözülmemişse, rastgele birini doğru belirle
                GameState.correctBox = Math.random() < 0.5 ? activeLockIndex : activeLockIndex + 1;
                correctBox = GameState.correctBox;
            }
            
            // Doğru kutunun çözülmemiş olduğundan emin ol
            if (GameState.correctBoxes.includes(correctBox)) {
                console.warn("Warning: The system tried to select an already solved box as correct!");
                // Diğer kutuyu seç - o da çözülmüşse bir sonraki çözülmemiş kutuyu bul
                if (correctBox === activeLockIndex) {
                    GameState.correctBox = activeLockIndex + 1;
                } else {
                    GameState.correctBox = activeLockIndex;
                }
                correctBox = GameState.correctBox;
                
                // Eğer bu da çözülmüşse, çözülmemiş ilk kutuyu bul
                if (GameState.correctBoxes.includes(correctBox) && unsolvedBoxes.length > 0) {
                    GameState.correctBox = unsolvedBoxes[0];
                    correctBox = GameState.correctBox;
                }
            }
            
            // Sadece kilit ikonunu vurgula, kutuları vurgulama
            highlightLockIcon(true);
            
            console.log("Selected lock:", activeLockIndex, "highlighted boxes:", highlightedBoxes, "correct box:", correctBox);
        }
        
        // Parlayan kutuları temizle
        function clearHighlightedBoxes() {
            const codeBoxes = codeRowEl.querySelectorAll('.box');
            highlightedBoxes.forEach(index => {
                codeBoxes[index].classList.remove('highlight');
            });
            
            GameState.highlightedBoxes = [];
            highlightedBoxes = [];
            GameState.correctBox = null;
            correctBox = null;
            
            // Tüm kilit ikonlarından highlight sınıfını kaldır
            const lockIcons = document.querySelectorAll('.lock-icon');
            lockIcons.forEach(icon => {
                icon.classList.remove('highlight');
            });
        }
        
        // İlgili kilit ikonunu vurgula
        function highlightLockIcon(skipBoxHighlight = false) {
            if (highlightedBoxes.length === 2 && highlightedBoxes[0] + 1 === highlightedBoxes[1]) {
                // Yan yana iki kutu varsa, aralarındaki kilidi vurgula
                const lockIcons = document.querySelectorAll('.lock-icon');
                const lockIndex = highlightedBoxes[0];
                
                if (lockIcons[lockIndex]) {
                    // Diğer vurguları temizle
                    lockIcons.forEach(icon => icon.classList.remove('highlight'));
                    // İlgili kilidi vurgula
                    lockIcons[lockIndex].classList.add('highlight');
                }
                
                // Kutuları vurgulama seçeneği
                if (!skipBoxHighlight) {
                    // İlgili kutuları da vurgula
                    const codeBoxes = codeRowEl.querySelectorAll('.box');
                    highlightedBoxes.forEach(index => {
                        codeBoxes[index].classList.add('highlight');
                    });
                }
            }
        }
        
        // 2. aşamada kutu eşleşmesini kontrol et
        function checkStage2Match() {
            // Hâlâ aşama 2'de olduğumuzu kontrol et
            if (GameState.currentStage !== 2) {
                console.log("Not in stage 2, returning");
                return;
            }
            
            const codeBoxes = codeRowEl.querySelectorAll('.box');
            const passwordBoxes = passwordRowEl.querySelectorAll('.box');
            
            console.log("Checking stage 2 match, selectedBox:", GameState.selectedBox, "boxStates:", GameState.boxStates);
            
            // Seçili bir kutu var mı ve bu kutu durdurulmuş mu kontrol et
            if (GameState.selectedBox !== null && GameState.boxStates[GameState.selectedBox] === false) {
                // Seçili kutunun o anki değerini al
                const spinner = codeBoxes[GameState.selectedBox].querySelector('.spinner');
                if (!spinner) {
                    console.error("Spinner element not found for box", GameState.selectedBox);
                    return;
                }
                
                const currentChar = spinner.textContent;
                const expectedChar = GameState.passwordRow[GameState.selectedBox];
                
                console.log("Current character:", currentChar, "Expected:", expectedChar);
                
                // Password'deki karakter ile karşılaştır
                if (currentChar === expectedChar) {
                    console.log("Match success!");
                    // Doğru eşleşme - görsel geri bildirim 
                    codeBoxes[GameState.selectedBox].classList.add('success');
                    passwordBoxes[GameState.selectedBox].classList.add('success');
                    
                    // Başarı sesi çal
                    SoundSystem.play('success');
                    
                    // Hafif titreşim animasyonu
                    codeBoxes[GameState.selectedBox].style.animation = 'pulse 0.5s';
                    passwordBoxes[GameState.selectedBox].style.animation = 'pulse 0.5s';
                    
                    // Geçici değişkenlerde seçili kutuyu saklayalım (setTimeout içinde kullanmak için)
                    const selectedBoxIndex = GameState.selectedBox;
                    
                    setTimeout(() => {
                        // Hâlâ aşama 2'de olduğumuzu kontrol et
                        if (GameState.currentStage !== 2) return;
                        
                        codeBoxes[selectedBoxIndex].style.animation = '';
                        passwordBoxes[selectedBoxIndex].style.animation = '';
                        
                        // Başarı stillerini kaldır, çözüldü stili ekle
                        codeBoxes[selectedBoxIndex].classList.remove('success');
                        passwordBoxes[selectedBoxIndex].classList.remove('success');
                        codeBoxes[selectedBoxIndex].classList.add('solved');
                        passwordBoxes[selectedBoxIndex].classList.add('solved');
                    }, 500);
                    
                    // Doğru kutuları kaydet
                    if (!GameState.correctBoxes.includes(GameState.selectedBox)) {
                        GameState.correctBoxes.push(GameState.selectedBox);
                        correctBoxes = GameState.correctBoxes;
                        console.log("Added to correctBoxes, now have:", GameState.correctBoxes.length);
                    }
                    
                    // Kutunun artık seçilemeyen duruma getirilmesi
                    codeBoxes[GameState.selectedBox].classList.remove('selected');
                    
                    // Seçimi kaldır
                    GameState.selectedBox = null;
                    selectedBox = null;
                    
                    // Connect butonunu güncelle
                    updateConnectButton();
                    
                    // Tüm kutular doğru mu kontrol et
                    if (GameState.correctBoxes.length === 9) {
                        console.log("All boxes matched! Starting final animation...");
                        setTimeout(() => {
                            SoundSystem.play('complete');
                            finalAnimation();
                        }, 500);
                    }
                } else {
                    console.log("Match failed");
                    // Eşleşme yok - hata göster
                    codeBoxes[GameState.selectedBox].classList.add('error');
                    
                    // Hata sesi çal
                    SoundSystem.play('error');
                    
                    // Geçici değişkenlerde seçili kutuyu saklayalım (setTimeout içinde kullanmak için)
                    const selectedBoxIndex = GameState.selectedBox;
                    
                    setTimeout(() => {
                        // Hâlâ aşama 2'de olduğumuzu kontrol et
                        if (GameState.currentStage !== 2) return;
                        
                        codeBoxes[selectedBoxIndex].classList.remove('error');
                        // Kutuyu yeniden başlat
                        startBoxSpinning(selectedBoxIndex);
                        GameState.boxStates[selectedBoxIndex] = true;
                        boxStates = GameState.boxStates;
                        codeBoxes[selectedBoxIndex].classList.remove('selected');
                        GameState.selectedBox = null;
                        selectedBox = null;
                        updateConnectButton();
                    }, 800);
                }
            } else if (GameState.selectedBox === null) {
                // Hiç kutu seçili değilse uyarı
                alert("Lütfen önce bir kutu seçin ve durdurun!");
            } else if (GameState.boxStates[GameState.selectedBox]) {
                // Kutu seçili ama durdurulmamış
                alert("Lütfen seçili kutuyu durdurmak için üzerine tıklayın!");
            }
        }
        
        // Final animasyonu - tüm kutular eşleştiğinde
        function finalAnimation() {
            // Tüm döngüleri durdur
            stopSpinning();
            
            // Animasyonları temizle
            clearAllAnimations();
            
            // Aşama göstergesini değiştir
            stageIndicator.textContent = "KİLİT AÇILIYOR";
            stageIndicator.style.color = "#00ffff";
            stageIndicator.classList.add('glitch-effect');
            
            // Üst kutularda dalgalanma efekti
            const passwordBoxes = passwordRowEl.querySelectorAll('.box');
            passwordBoxes.forEach(box => {
                box.style.animation = 'pulse 0.5s infinite alternate';
            });
            
            // Alt kutularda final karakterleri gösterme
            const codeBoxes = codeRowEl.querySelectorAll('.box');
            
            // İlk aşama - tüm kutularda hızlı scramble
            codeBoxes.forEach((box, index) => {
                const spinner = box.querySelector('.spinner');
                let localIndex = 0;
                
                // Glitch efekti ekle
                box.classList.add('glitch-effect');
                
                // Karakterleri hızla değiştir
                const changeInterval = setInterval(() => {
                    localIndex = (localIndex + 1) % characters.length;
                    spinner.textContent = characters[localIndex];
                }, 50);
                
                // Belirli bir süre sonra final karakterini göster
                setTimeout(() => {
                    clearInterval(changeInterval);
                    
                    // Animasyonu kaldır
                    box.classList.remove('glitch-effect');
                    
                    // Gecikme ile sırayla karakterleri görüntüle
                    setTimeout(() => {
                        spinner.textContent = finalCharacters[index];
                        box.classList.add('solved');
                        
                        // Son kutu gösterildiyse
                        if (index === 8) {
                            setTimeout(() => {
                                // Tüm kutularda "E-A-Y-D-I-N-1-2-3" mesajı 
                                passwordBoxes.forEach((box, idx) => {
                                    box.textContent = finalCharacters[idx];
                                    box.classList.add('glitch-effect');
                                });
                                
                                setTimeout(winGame, 3000);
                            }, 1000);
                        }
                    }, index * 300); // Her kutu 300ms ara ile
                }, 2000); // 2 saniye scramble
            });
        }
        
        // Orijinal olay dinleyicileri - diğer event listenerlarınız buraya
        window.addEventListener('load', function() {
            // Mevcut load event listener içeriği
            // Ekran yönünü kontrol et
            checkOrientation();
            
            // Oyun içi tam ekran butonuna tıklama olayı ekle
            const inGameFullscreenBtn = document.getElementById('in-game-fullscreen');
            if (inGameFullscreenBtn) {
                // İlk yüklemede tam ekran durumunu kontrol et ve simgeyi güncelle
                updateFullscreenButtonIcon();
                
                // Fare ile üzerine gelince efekt
                inGameFullscreenBtn.addEventListener('mouseenter', function() {
                    this.style.boxShadow = '0 0 8px #33ff33';
                    this.style.backgroundColor = 'rgba(51, 255, 51, 0.2)';
                });
                
                inGameFullscreenBtn.addEventListener('mouseleave', function() {
                    this.style.boxShadow = 'none';
                    this.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                });
                
                // Tıklama olayı
                inGameFullscreenBtn.addEventListener('click', function() {
                    toggleFullScreen();
                    // Pulsing animasyon ekle - tıklandığında görsel geri bildirim
                    this.style.animation = 'pulse 0.5s';
                    setTimeout(() => {
                        this.style.animation = '';
                    }, 500);
                });
                
                // Dokunmatik aygıtlar için
                inGameFullscreenBtn.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    this.style.backgroundColor = 'rgba(51, 255, 51, 0.2)';
                });
                
                inGameFullscreenBtn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    this.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                    toggleFullScreen();
                });
            }
            
            // Connect butonu olayını ayarla
            connectBtn.addEventListener('click', handleConnectClick);
            connectBtn.addEventListener('touchstart', function(e) {
                e.preventDefault();
                handleConnectClick();
            });
            
            // Aşama 2 için kutu tıklama olaylarını ekle
            const codeBoxes = codeRowEl.querySelectorAll('.box');
            codeBoxes.forEach((box, index) => {
                // Olay dinleyicilerini temizle (çakışmaları önlemek için)
                box.removeEventListener('click', box._clickHandler);
                box.removeEventListener('touchstart', box._touchHandler);
                
                // Click olayı - kutunun durumunu değiştir
                box._clickHandler = function(e) {
                    handleBoxClick(index);
                };
                
                // Dokunmatik olay - kutunun durumunu değiştir
                box._touchHandler = function(e) {
                    e.preventDefault(); // Tıklama olayının tetiklenmesini engelle
                    handleBoxClick(index);
                };
                
                // Olayları bağla
                box.addEventListener('click', box._clickHandler);
                box.addEventListener('touchstart', box._touchHandler);
            });
            
            // Klavye olaylarını dinle (Boşluk/Enter tuşları için)
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    connectBtn.click();
                }
            });
            
            // Ekran döndürme olayını dinle
            window.addEventListener('resize', handleResize);
            
            // Kilit ikonlarını oluştur ve konumlandır
            createLockIcons();
            
            // Bağlantı çizgilerini güncelle
            updateConnectorLines();
        });
        
        // Ekran yönünü kontrol et
        function checkOrientation(showAlert = true) {
            // Yatay ekran kontrolü
            if (window.innerWidth < window.innerHeight) {
                // Dikey ekran, uyarı göster
                if (showAlert) {
                    alert("Bu oyun yatay ekranda daha iyi çalışır. Lütfen cihazınızı yatay konuma çevirin.");
                }
                
                // Sarı uyarı bloğunu göster
                const warningElem = document.getElementById('orientation-warning');
                if (warningElem) {
                    warningElem.style.display = "block";
                }
            } else {
                // Yatay ekranda ise uyarı bloğunu gizle
                const warningElem = document.getElementById('orientation-warning');
                if (warningElem) {
                    warningElem.style.display = "none";
                }
            }
        }

        // Window yeniden boyutlandığında da kutular arası mesafeyi güncelle
        window.addEventListener('resize', handleResize);
        
        // Kilit ikonlarını oluştur ve konumlandır
        function createLockIcons() {
            // Sadece 1. aşamada kilit ikonlarını göster
            if (GameState.currentStage !== 1) {
                // Aşama 1 değilse tüm kilit ikonlarını gizle
                const lockContainer = document.getElementById('lock-container');
                lockContainer.innerHTML = '';
                return;
            }
            
            const container = document.querySelector('.game-container');
            const containerRect = container.getBoundingClientRect();
            const lockContainer = document.getElementById('lock-container');
            
            // Önceki kilit ikonlarını temizle
            lockContainer.innerHTML = '';
            
            // Password row ve code row kutularını al
            const passwordBoxes = passwordRowEl.querySelectorAll('.box');
            const codeBoxes = codeRowEl.querySelectorAll('.box');
            
            // 8 adet dikey kablo bağlantısı (9 kutu arasında 8 bağlantı) için kilit ikon oluştur
            for (let i = 0; i < 8; i++) {
                // Yan yana iki dikey kablo için:
                const box1 = passwordBoxes[i].getBoundingClientRect();
                const box2 = passwordBoxes[i+1].getBoundingClientRect();
                
                // İki kutunun X koordinatlarının ortasını hesapla
                const x1 = box1.left + box1.width/2;
                const x2 = box2.left + box2.width/2;
                const iconX = (x1 + x2) / 2;
                
                // Y koordinatını kabloların ortasında olacak şekilde hesapla
                const passwordBox = box1;
                const codeBox = codeBoxes[i].getBoundingClientRect();
                const iconY = passwordBox.bottom + (codeBox.top - passwordBox.bottom) / 2;
                
                // Container'a göre rölatif pozisyonu hesapla
                const relativeX = iconX - containerRect.left;
                const relativeY = iconY - containerRect.top;
                
                // Kilit ikonunu oluştur
                const lockIcon = document.createElement('div');
                lockIcon.className = 'lock-icon active';
                lockIcon.dataset.index = i; // Hangi kutu çiftine ait olduğunu belirle
                lockIcon.style.left = `${relativeX}px`;
                lockIcon.style.top = `${relativeY}px`;
                lockIcon.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                `;
                
                // Kilit ikonunu container'a ekle
                lockContainer.appendChild(lockIcon);
            }
            
            // Kilit ikonlarının durumlarını güncelle
            updateLockIconStates();
        }

        // Tam ekran modunu açar veya kapatır
        function toggleFullScreen() {
            if (!isFullScreen()) {
                requestFullScreen();
                
                // Mobil cihazlar için ek tam ekran denemesi
                if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                    setTimeout(tryMobileFullscreen, 300);
                }
            } else {
                exitFullScreen();
            }
            
            // Tam ekran buton simgesini güncelle (bir miktar gecikme ile)
            setTimeout(updateFullscreenButtonIcon, 300);
        }

        // Mevcut tam ekran durumunu kontrol eder
        function isFullScreen() {
            return !!(document.fullscreenElement || 
                      document.webkitFullscreenElement || 
                      document.mozFullScreenElement || 
                      document.msFullscreenElement);
        }

        // Tam ekran butonunun simgesini günceller
        function updateFullscreenButtonIcon() {
            const fullscreenBtn = document.getElementById('in-game-fullscreen');
            if (!fullscreenBtn) return;
            
            if (isFullScreen()) {
                // Tam ekrandaysa, çıkış simgesi göster
                fullscreenBtn.innerHTML = `
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#33ff33" stroke-width="2">
                        <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path>
                    </svg>
                `;
            } else {
                // Tam ekran değilse, giriş simgesi göster
                fullscreenBtn.innerHTML = `
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#33ff33" stroke-width="2">
                        <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
                    </svg>
                `;
            }
        }
    </script>
</body>
</html>
