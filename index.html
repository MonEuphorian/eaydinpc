<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CSI: Digital Evidence Unit</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Roboto Mono', monospace;
            color: #fff;
            position: relative;
        }

        /* Grid arka plan - cyberpunk stil */
        .grid-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255, 0, 128, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
            pointer-events: none;
            z-index: 1;
        }

        /* Ana oyun konteyneri */
        #gameContainer {
            position: relative;
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            z-index: 2;
            background-color: #000;
        }

        /* Timer */
        #timer {
            display: flex;
            justify-content: center;
            align-items: center;
            max-width: 95vw;
            margin: 10px auto;
            padding: 0 12px;
            box-sizing: border-box;
            word-break: break-all;
        }

        /* Monitör grupları */
        .monitorGrid {
            width: 100%;
            max-width: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            padding: 0 10px;
            margin-top: 48px;
        }

        .monitorRow {
            display: flex;
            justify-content: center;
            gap: 10px;
            width: 100%;
            max-width: 600px;
        }

        /* Üst ve alt kutular arasındaki mesafeyi artır */
        #passwordRow {
            margin-bottom: 60px;
        }

        /* Monitör stilleri */
        .monitor {
            width: min(8.5vw, 50px);
            height: min(8.5vw, 50px);
            border: 2px solid;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: min(4vw, 24px);
            font-weight: bold;
            background: rgba(10, 10, 15, 0.9);
            position: relative;
            transition: all 0.3s ease;
            text-shadow: 0 0 5px currentColor;
        }

        .password-monitor {
            border-color: #ff2e6d;
            color: #ff2e6d;
            box-shadow: 0 0 5px rgba(255, 46, 109, 0.3);
        }

        .code-monitor {
            border-color: #ff2e6d;
            color: #ff2e6d;
            box-shadow: 0 0 5px rgba(255, 46, 109, 0.3);
        }

        /* Sadece alt monitörlerde (codeRow) seçim efekti olacak */
        .code-monitor.selected {
            border-color: #00ffe0 !important;
            box-shadow: 0 0 24px #00ffe0, 0 0 8px #00ffe0;
            background: rgba(0,255,224,0.10);
            color: #00ffe0;
            transform: scale(1.13);
            z-index: 10;
        }
        /* Üst monitörlerde seçim efekti olmasın */
        .password-monitor.selected {
            border-color: inherit;
            box-shadow: none;
            background: inherit;
            color: inherit;
            transform: none;
            z-index: 1;
        }

        /* Kontrol paneli */
        #controlPanel {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 96px;
            z-index: 10;
            width: 100vw;
            max-width: 100vw;
            padding: 10px 0 0 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            background-color: #000;
            box-shadow: 0 -2px 24px 0 rgba(0,0,0,0.5);
        }

        /* Kontrol panelinin üstündeki yatay çizgi */
        .control-separator {
            width: 100vw;
            height: 2px;
            background: linear-gradient(90deg, transparent 0%, #00ffff 40%, #00ffff 60%, transparent 100%);
            box-shadow: 0 0 8px #00ffff, 0 0 2px #fff;
            margin-bottom: 18px;
            border: none;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 20;
        }

        .controlRow {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 500px;
            gap: 8px;
        }

        /* Kontrol butonları */
        #usb {
            width: min(30vw, 120px);
            height: min(30vw, 120px);
            border: 3px solid #ff2e6d;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(10, 10, 15, 0.9);
            font-size: min(10vw, 40px);
            box-shadow: 0 0 10px rgba(255, 46, 109, 0.3);
        }

        #usb.active {
            border-color: #00ffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
            color: #00ffff;
        }

        .arrowBtn {
            width: min(20vw, 80px);
            height: min(20vw, 80px);
            border: 2px solid #00ffff;
            background: rgba(10, 10, 15, 0.9);
            color: #00ffff;
            font-size: min(8vw, 32px);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
            margin-left: 16px;
            margin-right: 16px;
        }

        #connectBtn {
            width: min(80vw, 300px);
            height: min(15vw, 60px);
            border: 2px solid #00ffff;
            background: rgba(10, 10, 15, 0.9);
            color: #00ffff;
            font-size: min(5vw, 24px);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 2px;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        /* Kalkan simgeleri */
        .shield {
            width: min(5vw, 25px);
            height: min(5vw, 25px);
            border: 2px solid #00ffff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            background: rgba(10, 10, 15, 0.9);
            transition: all 0.3s ease;
            font-size: min(3vw, 14px);
            color: #00ffff;
        }

        .shield.active {
            border-color: #ff2e6d;
            color: #ff2e6d;
            box-shadow: 0 0 10px rgba(255, 46, 109, 0.5);
        }

        /* Oyun ekranları */
        .gameScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(10, 10, 15, 0.95);
            z-index: 100;
            gap: 30px;
            padding: 20px;
        }

        .screenTitle {
            font-size: min(8vw, 48px);
            color: #00ffff;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        .screenText {
            font-size: min(4vw, 24px);
            color: #fff;
            text-align: center;
            max-width: 600px;
            line-height: 1.5;
            padding: 0 20px;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }

        .bigBtn {
            padding: 15px 40px;
            border: 3px solid #00ffff;
            background: rgba(10, 10, 15, 0.9);
            color: #00ffff;
            font-size: min(5vw, 24px);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 2px;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
        }

        .hidden {
            display: none !important;
        }

        /* Aktif durum efektleri */
        .monitor.selected,
        .arrowBtn:active,
        #connectBtn:active,
        #usb:active,
        .bigBtn:active {
            transform: scale(0.95);
        }

        /* Dokunmatik cihazlar için hover efektleri */
        @media (hover: hover) {
            .arrowBtn:hover,
            #connectBtn:hover,
            .bigBtn:hover {
                background: rgba(0, 255, 255, 0.1);
                box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
            }

            #usb:hover {
                background: rgba(255, 46, 109, 0.1);
                box-shadow: 0 0 20px rgba(255, 46, 109, 0.5);
            }
        }

        /* Küçük ekranlar için optimizasyonlar */
        @media (max-height: 667px) {
            #gameContainer {
                padding: 10px;
            }

            .monitorGrid {
                gap: 15px;
            }

            #controlPanel {
                padding: 10px;
            }
        }

        /* ShieldRow ve shield-wrapper için yeni CSS */
        .shieldRow {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            min-height: 30px;
            position: relative;
            z-index: 2;
        }
        .shield-wrapper {
            flex: 1 1 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Oyun alanı ile kontrol paneli arasında boşluk bırak */
        #gameArea {
            padding-bottom: 120px;
        }
        @media (max-width: 600px) {
            #controlPanel {
                padding-bottom: 0;
                min-height: 120px;
                bottom: 96px;
            }
            #gameArea {
                padding-bottom: 140px;
            }
            #timer {
                margin-top: 32px;
            }
            .monitorGrid {
                margin-top: 96px;
            }
            .controlRow {
                gap: 2px;
            }
            .arrowBtn {
                margin-left: 24px;
                margin-right: 24px;
            }
            .gameField {
                margin-bottom: 140px;
            }
            #passwordRow {
                margin-bottom: 60px;
            }
        }

        /* Dikey kablo (wire) stilleri */
        .monitor-vertical-wire {
            position: absolute;
            width: 2px;
            background: #222;
            border-radius: 1px;
            z-index: 1;
            pointer-events: none;
            box-shadow: 0 0 8px #000, 0 2px 8px #444;
        }

        /* Shield ikonları (kabloların ortasında, fuşya) */
        .shield-icon {
            position: absolute;
            width: 28px;
            height: 28px;
            left: 0;
            top: 0;
            z-index: 3;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }
        .shield-icon svg {
            width: 28px;
            height: 28px;
            display: block;
        }
        .shield-icon .shield-shape {
            fill: #1a0010;
            stroke: #ff2e6d;
            stroke-width: 2.5px;
            filter: drop-shadow(0 0 8px #ff2e6d);
        }

        /* Shield altından cyan çizgiye inen beyaz kablo */
        .shield-down-wire {
            position: absolute;
            width: 1px;
            background: #222;
            box-shadow: none;
            opacity: 0.5;
            z-index: 2;
            left: 0;
            top: 0;
            pointer-events: none;
            border-radius: 1px;
        }

        /* Oyun alanı (kutular ve kablolar) için ortalama kapsayıcı */
        .gameField {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1 1 auto;
            min-height: 0;
            height: 100%;
            margin-bottom: 140px;
        }
        #gameArea {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding-bottom: 120px;
        }
        @media (max-width: 600px) {
            .gameField {
                min-height: 0;
                height: 100%;
                justify-content: center;
                margin-bottom: 140px;
            }
            #gameArea {
                padding-bottom: 140px;
            }
            #controlPanel {
                bottom: 96px;
            }
        }

        /* Animasyonlu antivirüs dairesi (yeni timer) */
        #antivirusCircle {
            position: absolute;
            top: 48px;
            left: 50%;
            transform: translateX(-50%);
            width: 110px;
            height: 110px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
        }
        #antivirusCircle svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 110px;
            height: 110px;
        }
        #antivirusTime {
            position: relative;
            color: #00ffe0;
            font-size: 2.8rem;
            font-family: 'Digital-7', 'Roboto Mono', monospace;
            font-weight: bold;
            text-align: center;
            width: 110px;
            line-height: 110px;
            z-index: 2;
            text-shadow: 0 0 12px #00ffe0, 0 0 2px #fff;
            pointer-events: none;
            margin: 0;
            padding: 0;
        }
        #antivirusSpinnerInner {
            stroke: #00ffe0;
            filter: drop-shadow(0 0 8px #00ffe0);
            transform-origin: 55px 55px;
            animation: antivirus-spin 2s linear infinite;
        }
        #antivirusSpinnerOuter {
            stroke: #00ffe0;
            filter: drop-shadow(0 0 8px #00ffe0);
            transform-origin: 55px 55px;
            animation: antivirus-spin-reverse 3s linear infinite;
            opacity: 0.7;
        }
        @keyframes antivirus-spin {
            100% { transform: rotate(360deg); }
        }
        @keyframes antivirus-spin-reverse {
            100% { transform: rotate(-360deg); }
        }
        @media (max-width: 600px) {
            #antivirusCircle {
                width: 80px;
                height: 80px;
                top: 28px;
            }
            #antivirusCircle svg {
                width: 80px;
                height: 80px;
            }
            #antivirusTime {
                font-size: 1.7rem;
                width: 80px;
                line-height: 80px;
            }
        }

        /* Cyan efekt stilleri */
        .shield-icon.active-cyan svg .shield-shape { 
            stroke: #00ffff !important; 
            filter: drop-shadow(0 0 8px #00ffff); 
        }
        .monitor-vertical-wire.cable-glow { 
            box-shadow: 0 0 4px rgba(0, 255, 255, 0.15), 0 0 1px rgba(0, 255, 255, 0.1); 
            background: rgba(0, 255, 255, 0.2) !important; 
        }
        #usb.usb-cyan { 
            border-color: #00ffff !important; 
            box-shadow: 0 0 20px #00ffff, 0 0 10px #00ffff; 
            color: #00ffff; 
        }
    </style>
</head>
<body>
    <div class="grid-overlay"></div>
    
    <div id="gameContainer">
        <!-- Başlangıç ekranı -->
        <div id="startScreen" class="gameScreen">
            <h1 class="screenTitle">CSI: Digital Evidence Unit</h1>
            <p class="screenText">Şüpheli cihazın şifresini kırın ve delillere ulaşın. Her deneme için 60 saniyeniz var.</p>
            <button id="startButton" class="bigBtn">BAŞLAT</button>
        </div>

        <!-- Ana oyun alanı -->
        <div id="gameArea" class="hidden">
            <div class="gameField">
                <div class="monitorGrid">
                    <div class="monitorRow" id="passwordRow">
                        <!-- Şifre monitörleri JavaScript ile eklenecek -->
                    </div>
                    <div class="monitorRow" id="codeRow">
                        <!-- Kod monitörleri JavaScript ile eklenecek -->
                    </div>
                </div>
            </div>

            <div id="controlPanel">
                <div class="control-separator"></div>
                <div class="controlRow">
                    <button id="leftBtn" class="arrowBtn">←</button>
                    <div id="usb">
                        <div id="usbIcon">⚡</div>
                    </div>
                    <button id="rightBtn" class="arrowBtn">→</button>
                </div>
                <button id="connectBtn">BAĞLAN</button>
            </div>

            <!-- Animasyonlu antivirüs dairesi (yeni timer) -->
            <div id="antivirusCircle">
                <svg width="110" height="110" viewBox="0 0 110 110">
                    <circle cx="55" cy="55" r="48" stroke="#00ffe0" stroke-width="3" fill="none" opacity="0.15"/>
                    <circle id="antivirusSpinnerOuter" cx="55" cy="55" r="48" stroke="#00ffe0" stroke-width="3" fill="none" stroke-linecap="round" stroke-dasharray="80 220"/>
                    <circle cx="55" cy="55" r="38" stroke="#00ffe0" stroke-width="4" fill="none" opacity="0.15"/>
                    <circle id="antivirusSpinnerInner" cx="55" cy="55" r="38" stroke="#00ffe0" stroke-width="4" fill="none" stroke-linecap="round" stroke-dasharray="60 180"/>
                </svg>
                <div id="antivirusTime">60</div>
            </div>
        </div>

        <!-- Oyun sonu ekranı -->
        <div id="gameOverScreen" class="gameScreen hidden">
            <h1 class="screenTitle">ERİŞİM BAŞARISIZ</h1>
            <p class="screenText">Güvenlik sistemi erişimi engelledi. Yeni bir deneme başlatın.</p>
            <button id="restartButton" class="bigBtn">TEKRAR DENE</button>
        </div>

        <!-- Kazanma ekranı -->
        <div id="winScreen" class="gameScreen hidden">
            <h1 class="screenTitle">ERİŞİM BAŞARILI</h1>
            <p class="screenText">Şifre kırıldı. Kalan süre: <span id="remainingTime">00:00</span></p>
            <button id="nextLevelButton" class="bigBtn">DEVAM ET</button>
        </div>

        <!-- Tutorial Modal -->
        <div id="tutorialModal" class="gameScreen" style="z-index: 200; display: none; background: rgba(0,0,0,0.97);">
            <div id="tutorialContent" style="max-width: 400px; width: 90vw; text-align: center;">
                <h2 id="tutorialTitle" style="color: #00ffff; margin-bottom: 18px;"></h2>
                <div id="tutorialText" style="color: #fff; font-size: 1.2em; min-height: 80px; margin-bottom: 24px;"></div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <button id="tutorialPrev" class="arrowBtn">←</button>
                    <button id="tutorialSkip" class="bigBtn" style="font-size: 1em; padding: 8px 18px;">ATLAMA</button>
                    <button id="tutorialNext" class="arrowBtn">→</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Oyun değişkenleri
        let gameStarted = false;
        let timer = 60;
        let timerInterval;
        let selectedMonitorIndex = 0;
        let currentLevel = 1;
        let isUSBActive = false;
        let antivirusTime = 60;
        
        // Stage-1 için değişkenler
        let activeShieldIndex = -1;        // Aktif olan shield'ın indeksi
        let correctBoxIndex = -1;          // Doğru kutunun indeksi
        let unlockedPasswordCount = 0;     // Açılan şifre sayısı
        let unlockedBoxes = [];           // Çözülmüş kutular

        // Test modu ve stage kontrolü için değişkenler
        let isTestMode = false;
        let startingStage = 1;

        // Kutu hızlarını ve karakter indekslerini saklamak için değişkenler
        let boxSpeeds = [];
        let currentCharIndices = Array(9).fill(0);

        // Sayfa yüklendiğinde test modu kontrolü
        window.addEventListener('DOMContentLoaded', function() {
            // URL'den stage parametresini kontrol et
            const urlParams = new URLSearchParams(window.location.search);
            const stageParam = urlParams.get('stage');
            if (stageParam === '2') {
                isTestMode = true;
                startingStage = 2;
                console.log('Test modu aktif: Stage-2');
            }
        });

        // Gizli tuş kombinasyonu için event listener
        document.addEventListener('keydown', function(e) {
            // Ctrl + Shift + 2 kombinasyonu
            if (e.ctrlKey && e.shiftKey && e.key === '@') {
                isTestMode = true;
                startingStage = 2;
                console.log('Test modu aktif: Stage-2');
                // Eğer oyun başlamamışsa direkt Stage-2 ile başla
                if (!gameStarted) {
                    startGame();
                }
                // Eğer oyun başlamışsa Stage-2'ye geç
                else {
                    startStage2();
                }
            }
        });

        // Stage-2'ye geçiş fonksiyonunu güncelle
        function startStage2() {
            currentLevel = 2;
            // Mevcut oyun durumunu temizle
            clearInterval(timerInterval);
            
            // Stage-2 için yeni değerleri ayarla
            timer = 90;
            unlockedPasswordCount = 0;
            unlockedBoxes = [];
            activeShieldIndex = -1;
            correctBoxIndex = -1;
            
            // Shield'ları Stage-2 için gizle
            document.querySelectorAll('.shield-icon').forEach(shield => {
                if (currentLevel === 2) {
                    shield.style.display = 'none';
                } else {
                    shield.style.display = 'flex';
                }
            });
            
            // Önce monitörleri oluştur
            createMonitors();
            
            // Sonra üst sıra şifrelerini ayarla
            setupStage2Passwords();
            
            // Son olarak alt sıra dönüşünü başlat
            startCodeRowSpinStage2();
            
            // Stage-2 için tutorial'ı göster
            if (!isTestMode) {
                showTutorial2();
            } else {
                startTimer(90);
            }
        }

        // Oyun başlatma fonksiyonunu güncelle
        function startGame() {
            if (isTestMode && startingStage === 2) {
                // Shield sistemini devre dışı bırak ve Stage-2'yi başlat
                startScreen.classList.add('hidden');
                gameArea.classList.remove('hidden');
                gameStarted = true;
                startStage2();
            } else {
                createMonitors();
                startCodeRowSpin();
                startTimer(60); // Stage-1 için 60 saniye
            }
            gameStarted = true;
        }

        // Oyun sonu fonksiyonunu güncelle
        function endGame(won) {
            gameStarted = false;
            clearInterval(timerInterval);
            
            if(won) {
                if (currentLevel === 1 && !isTestMode) {
                    // Stage-1 tamamlandı, Stage-2'ye geç
                    document.getElementById('remainingTime').textContent = timerElement.textContent;
                    setTimeout(() => {
                        // Shield'ları Stage-2 için gizle
                        document.querySelectorAll('.shield-icon').forEach(shield => {
                            shield.style.display = 'none';
                        });
                        startStage2();
                    }, 1000);
                } else {
                    // Oyun tamamen bitti
                    document.getElementById('remainingTime').textContent = timerElement.textContent;
                    winScreen.classList.remove('hidden');
                    gameArea.classList.add('hidden');
                }
            } else {
                gameOverScreen.classList.remove('hidden');
                gameArea.classList.add('hidden');
            }
        }

        // ===== Stage-1: codeRow Otomatik Spin (Farklı Hızlar) =====
        const SPIN_CHARS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let codeRowSpinIntervals = [];
        let isSpinning = false;

        function startCodeRowSpin() {
            stopCodeRowSpin();
            isSpinning = true;
            const codeMonitors = codeRow.children;
            for (let i = 0; i < codeMonitors.length; i++) {
                // Her kutuya farklı hız (ör: 60ms + i*30ms)
                const speed = 60 + i * 30;
                codeRowSpinIntervals[i] = setInterval(() => {
                    const randChar = SPIN_CHARS[Math.floor(Math.random() * SPIN_CHARS.length)];
                    codeMonitors[i].textContent = randChar;
                }, speed);
            }
        }

        function stopCodeRowSpin() {
            isSpinning = false;
            for (let i = 0; i < codeRowSpinIntervals.length; i++) {
                clearInterval(codeRowSpinIntervals[i]);
            }
            codeRowSpinIntervals = [];
        }

        // DOM elementleri
        const gameArea = document.getElementById('gameArea');
        const startScreen = document.getElementById('startScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const winScreen = document.getElementById('winScreen');
        const timerElement = document.getElementById('timer');
        const passwordRow = document.getElementById('passwordRow');
        const codeRow = document.getElementById('codeRow');
        const usb = document.getElementById('usb');
        const connectBtn = document.getElementById('connectBtn');
        const leftBtn = document.getElementById('leftBtn');
        const rightBtn = document.getElementById('rightBtn');

        // Monitörleri oluştur
        function createMonitors() {
            // Önce mevcut monitörleri temizle
            passwordRow.innerHTML = '';
            codeRow.innerHTML = '';
            // Eski shield'ları ve kabloları temizle
            document.querySelectorAll('.shield').forEach(shield => shield.remove());
            document.querySelectorAll('.monitor-vertical-wire').forEach(wire => wire.remove());

            for(let i = 0; i < 9; i++) {
                // Şifre monitörleri
                const passwordMonitor = document.createElement('div');
                passwordMonitor.className = 'monitor password-monitor';
                passwordMonitor.dataset.index = i;
                passwordRow.appendChild(passwordMonitor);

                // Kod monitörleri
                const codeMonitor = document.createElement('div');
                codeMonitor.className = 'monitor code-monitor';
                codeMonitor.dataset.index = i;
                codeRow.appendChild(codeMonitor);
            }

            // Dikey kabloları ve shield'ları doğru konumlandır
            setTimeout(() => {
                positionVerticalWires();
                // Shield'ları sadece Stage-1'de göster
                if (currentLevel !== 2) {
                    positionShields();
                }
            }, 0);
            updateSelection();
        }

        // Kutu seçimini güncelle
        function updateSelection() {
            const previousIndex = lastSelectedIndex;

            // Tüm seçimleri kaldır
            Array.from(passwordRow.children).forEach(monitor => {
                monitor.classList.remove('selected');
            });
            Array.from(codeRow.children).forEach(monitor => {
                monitor.classList.remove('selected');
            });

            if (currentLevel === 2) {
                // Stage-2'de çözülmüş kutuları atla
                if (unlockedBoxes.includes(selectedMonitorIndex)) {
                    // 0 ve 8 numaralı kutular hariç, üzerinden atla
                    if (selectedMonitorIndex > 0 && selectedMonitorIndex < 8) {
                        // Son hareketin yönünü belirle (sağa mı sola mı gidiyorduk)
                        const goingRight = selectedMonitorIndex > lastSelectedIndex;
                        
                        if (goingRight) {
                            // Sağa doğru git
                            while (selectedMonitorIndex < 8 && unlockedBoxes.includes(selectedMonitorIndex)) {
                                selectedMonitorIndex++;
                            }
                        } else {
                            // Sola doğru git
                            while (selectedMonitorIndex > 0 && unlockedBoxes.includes(selectedMonitorIndex)) {
                                selectedMonitorIndex--;
                            }
                        }
                        
                        // Eğer gittiğimiz yönde çözülmemiş kutu yoksa, diğer yöne dene
                        if (unlockedBoxes.includes(selectedMonitorIndex)) {
                            selectedMonitorIndex = lastSelectedIndex; // Önceki konuma dön
                            if (goingRight) {
                                // Sola git
                                while (selectedMonitorIndex > 0 && unlockedBoxes.includes(selectedMonitorIndex)) {
                                    selectedMonitorIndex--;
                                }
                            } else {
                                // Sağa git
                                while (selectedMonitorIndex < 8 && unlockedBoxes.includes(selectedMonitorIndex)) {
                                    selectedMonitorIndex++;
                                }
                            }
                            // Eğer hiç çözülmemiş kutu kalmadıysa
                            if (unlockedBoxes.includes(selectedMonitorIndex)) {
                                selectedMonitorIndex = lastSelectedIndex;
                            }
                        }
                    } else {
                        // 0 veya 8 numaralı kutudaysak, en yakın çözülmemiş kutuya git
                        if (selectedMonitorIndex === 0) {
                            // 0'dayız, sağa git
                            selectedMonitorIndex = 1;
                            while (selectedMonitorIndex < 8 && unlockedBoxes.includes(selectedMonitorIndex)) {
                                selectedMonitorIndex++;
                            }
                            if (unlockedBoxes.includes(selectedMonitorIndex)) {
                                selectedMonitorIndex = 0; // Hiç çözülmemiş kutu yoksa 0'a dön
                            }
                        } else if (selectedMonitorIndex === 8) {
                            // 8'deyiz, sola git
                            selectedMonitorIndex = 7;
                            while (selectedMonitorIndex > 0 && unlockedBoxes.includes(selectedMonitorIndex)) {
                                selectedMonitorIndex--;
                            }
                            if (unlockedBoxes.includes(selectedMonitorIndex)) {
                                selectedMonitorIndex = 8; // Hiç çözülmemiş kutu yoksa 8'e dön
                            }
                        }
                    }
                }

                // Önceki kutudan ayrılıyorsak, çözülmemişse ve döngüsü durmuşsa otomatik başlat
                if (
                    previousIndex !== selectedMonitorIndex &&
                    !unlockedBoxes.includes(previousIndex) &&
                    codeRowSpinIntervals[previousIndex] == null
                ) {
                    startSingleBoxSpin(previousIndex);
                }

                // USB butonunun durumunu güncelle
                const isCurrentSpinning = codeRowSpinIntervals[selectedMonitorIndex] !== null;
                isUSBActive = !isCurrentSpinning;
                usb.classList.toggle('active', !isCurrentSpinning);
            }

            // Seçili kutuyu vurgula
            if (codeRow.children[selectedMonitorIndex]) {
                codeRow.children[selectedMonitorIndex].classList.add('selected');
                lastSelectedIndex = selectedMonitorIndex;
            }
        }

        // Timer fonksiyonu
        function startTimer(seconds) {
            timer = seconds;
            antivirusTime = seconds;
            updateTimerDisplay();
            updateAntivirusTimeDisplay();

            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timer--;
                antivirusTime--;
                updateTimerDisplay();
                updateAntivirusTimeDisplay();

                if(timer <= 0) {
                    clearInterval(timerInterval);
                    endGame(false);
                }
                // Antivirüs süresi sıfırlanırsa burada reset animasyonu ve şifre reseti eklenebilir
                if(antivirusTime <= 0) {
                    antivirusTime = seconds;
                    updateAntivirusTimeDisplay();
                    // TODO: Şifre resetleme ve animasyon efekti burada tetiklenecek
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timer / 60);
            const seconds = timer % 60;
            const formatted = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            if (typeof timerElement !== 'undefined' && timerElement) timerElement.textContent = formatted;
            const antivirusTimeEl = document.getElementById('antivirusTime');
            if (antivirusTimeEl) antivirusTimeEl.textContent = timer;
        }

        // Event Listeners
        document.getElementById('startButton').addEventListener('click', () => {
            startScreen.classList.add('hidden');
            gameArea.classList.remove('hidden');
            if (isTestMode && startingStage === 2) {
                startStage2();
            } else {
                gameStarted = true;
                createMonitors();
                startTimer(60);
                startCodeRowSpin();
            }
        });

        document.getElementById('restartButton').addEventListener('click', () => {
            location.reload();
        });

        document.getElementById('nextLevelButton').addEventListener('click', () => {
            currentLevel++;
            gameArea.classList.remove('hidden');
            winScreen.classList.add('hidden');
            createMonitors();
            startTimer(60);
        });

        // Kontrol butonları
        leftBtn.addEventListener('click', () => {
            if (!gameStarted) return;
            selectedMonitorIndex = Math.max(0, selectedMonitorIndex - 1);
            updateSelection();
        });

        rightBtn.addEventListener('click', () => {
            if (!gameStarted) return;
            selectedMonitorIndex = Math.min(8, selectedMonitorIndex + 1);
            updateSelection();
        });

        // Rastgele shield seçme fonksiyonu
        function pickRandomShield() {
            // Seçilebilir shield'ları bul
            const availableShields = [];
            
            // Her shield için kontrol et (0'dan 7'ye kadar)
            for (let shieldIndex = 0; shieldIndex < 8; shieldIndex++) {
                // Bu shield'ın sorumlu olduğu kutular
                // Shield 0 -> Kutu 0,1
                // Shield 1 -> Kutu 1,2
                // Shield 2 -> Kutu 2,3 ...
                const firstBox = shieldIndex;
                const secondBox = shieldIndex + 1;
                
                // Her iki kutu da çözülmüşse bu shield'ı atla
                const firstBoxSolved = unlockedBoxes.includes(firstBox);
                const secondBoxSolved = unlockedBoxes.includes(secondBox);
                
                if (firstBoxSolved && secondBoxSolved) {
                    // Bu shield'ın her iki kutusu da çözülmüş, bu shield'ı atla
                    continue;
                }
                
                // En az bir kutu çözülmemişse bu shield seçilebilir
                availableShields.push(shieldIndex);
            }

            // Debug için konsola yazdır
            console.log('Seçilebilir shield\'lar:', availableShields);
            console.log('Çözülmüş kutular:', unlockedBoxes);

            // Kullanılabilir shield kalmadıysa -1 döndür
            if (availableShields.length === 0) return -1;

            // Kullanılabilir shield'lardan birini rastgele seç
            const randomIndex = Math.floor(Math.random() * availableShields.length);
            const selectedShield = availableShields[randomIndex];
            
            // Debug için seçilen shield'ı yazdır
            console.log('Seçilen shield:', selectedShield);
            
            return selectedShield;
        }

        // Shield'ın altındaki iki kutudan birini seç
        function pickCorrectBox(shieldIndex) {
            // Shield'ın sorumlu olduğu kutular
            const firstBox = shieldIndex;
            const secondBox = shieldIndex + 1;

            // İki kutudan biri çözülmüşse, diğeri doğru olmalı
            if (unlockedBoxes.includes(firstBox)) {
                return secondBox;  // İlk kutu çözülmüşse ikinci kutu doğru
            } else if (unlockedBoxes.includes(secondBox)) {
                return firstBox;   // İkinci kutu çözülmüşse ilk kutu doğru
            }

            // Her iki kutu da çözülmemişse rastgele seç
            return Math.random() < 0.5 ? firstBox : secondBox;
        }

        // Shield ve kabloları vurgulama fonksiyonu
        function highlightShieldAndCables(shieldIndex) {
            // Tüm shield ve kabloları reset
            document.querySelectorAll('.shield-icon').forEach(shield => shield.classList.remove('active-cyan'));
            document.querySelectorAll('.monitor-vertical-wire').forEach(wire => wire.classList.remove('cable-glow'));

            // Seçilen shield'ı vurgula
            const shields = document.querySelectorAll('.shield-icon');
            const selectedShield = shields[shieldIndex];
            if (selectedShield) {
                selectedShield.classList.add('active-cyan');
            }

            // Komşu kabloları kısa süreli vurgula
            const wires = document.querySelectorAll('.monitor-vertical-wire');
            if (wires[shieldIndex]) {
                wires[shieldIndex].classList.add('cable-glow');
                setTimeout(() => wires[shieldIndex].classList.remove('cable-glow'), 150);
            }
            if (wires[shieldIndex + 1]) {
                wires[shieldIndex + 1].classList.add('cable-glow');
                setTimeout(() => wires[shieldIndex + 1].classList.remove('cable-glow'), 150);
            }
        }

        // Şifre açma kontrolü
        function checkPassword() {
            // Eğer aktif shield yoksa veya USB aktif değilse
            if (activeShieldIndex === -1 || !isUSBActive) return false;

            // Seçili kutu daha önce çözülmüş mü?
            if (unlockedBoxes.includes(selectedMonitorIndex)) {
                return false;
            }

            // Debug için konsola yazdır
            console.log('Aktif shield:', activeShieldIndex);
            console.log('Seçili kutu:', selectedMonitorIndex);
            console.log('Doğru kutu:', correctBoxIndex);

            // Seçili kutu, aktif shield'ın altındaki doğru kutu mu?
            if (selectedMonitorIndex === correctBoxIndex) {
                // Doğru kutuyu bulduk!
                const passwordMonitors = document.querySelectorAll('.password-monitor');
                const codeMonitors = document.querySelectorAll('.code-monitor');
                
                // Seçilen kutudaki karakteri al
                const selectedChar = codeMonitors[correctBoxIndex].textContent;
                
                // Üstteki şifreyi güncelle
                if (passwordMonitors[correctBoxIndex]) {
                    passwordMonitors[correctBoxIndex].textContent = selectedChar;
                    passwordMonitors[correctBoxIndex].style.color = '#00ffff'; // Harf cyan
                    passwordMonitors[correctBoxIndex].style.borderColor = '#ff2e6d'; // Kutu fuşya
                    passwordMonitors[correctBoxIndex].style.boxShadow = '0 0 10px #ff2e6d'; // Gölge fuşya
                }

                // Bu shield için açılan kutuyu kaydet
                unlockedBoxes.push(correctBoxIndex);

                // İlerlemeyi kaydet
                unlockedPasswordCount++;

                // Debug için konsola yazdır
                console.log('Çözülen kutular:', unlockedBoxes);

                // Tüm şifreler açıldı mı?
                if (unlockedPasswordCount === 9) {
                    setTimeout(() => endGame(true), 500);
                }

                return true;
            }

            return false;
        }

        // USB tıklama olayını güncelle (Stage-2 için)
        usb.addEventListener('click', () => {
            if (!gameStarted) return;
            
            // USB'yi cyan yap ve 300ms sonra kaldır
            usb.classList.add('usb-cyan');
            setTimeout(() => usb.classList.remove('usb-cyan'), 300);

            if (currentLevel === 1) {
                // Stage-1 mantığı aynen kalıyor
                if (isSpinning) {
                    stopCodeRowSpin();
                    activeShieldIndex = pickRandomShield();
                    if (activeShieldIndex !== -1) {
                        correctBoxIndex = pickCorrectBox(activeShieldIndex);
                        highlightShieldAndCables(activeShieldIndex);
                        isUSBActive = !isUSBActive;
                        usb.classList.toggle('active');
                    }
                } else {
                    startCodeRowSpin();
                    activeShieldIndex = -1;
                    correctBoxIndex = -1;
                    document.querySelectorAll('.shield-icon').forEach(shield => shield.classList.remove('active-cyan'));
                    document.querySelectorAll('.monitor-vertical-wire').forEach(wire => wire.classList.remove('cable-glow'));
                    isUSBActive = !isUSBActive;
                    usb.classList.toggle('active');
                }
            } else {
                // Stage-2 mantığı: Sadece seçili kutuyu kontrol et
                const selectedMonitor = selectedMonitorIndex;
                
                // Seçili kutu çözülmüşse hiçbir şey yapma
                if (unlockedBoxes.includes(selectedMonitor)) return;

                if (codeRowSpinIntervals[selectedMonitor]) {
                    // Bu kutu dönüyorsa durdur
                    stopBoxSpin(selectedMonitor);
                    isUSBActive = true;
                } else {
                    // Bu kutu duruyorsa başlat
                    startSingleBoxSpin(selectedMonitor);
                    isUSBActive = false;
                }
                usb.classList.toggle('active');
            }
        });

        // Connect butonunu güncelle
        connectBtn.addEventListener('click', () => {
            if (!gameStarted || !isUSBActive) return;

            if (currentLevel === 1) {
                // Stage-1 mantığı
                if (checkPassword()) {
                    // Doğru kutuyu bulduk, efekt göster
                    const selectedMonitor = document.querySelectorAll('.code-monitor')[selectedMonitorIndex];
                    if (selectedMonitor) {
                        selectedMonitor.style.color = '#00ffff';
                        selectedMonitor.style.borderColor = '#00ffff';
                        selectedMonitor.style.boxShadow = '0 0 20px #00ffff';
                        setTimeout(() => {
                            selectedMonitor.style.color = '';
                            selectedMonitor.style.borderColor = '';
                            selectedMonitor.style.boxShadow = '';
                        }, 500);
                    }
                } else {
                    // Yanlış kutu, kırmızı efekt göster ve spin'i yeniden başlat
                    const selectedMonitor = document.querySelectorAll('.code-monitor')[selectedMonitorIndex];
                    if (selectedMonitor) {
                        selectedMonitor.style.color = '#ff2e6d';
                        selectedMonitor.style.borderColor = '#ff2e6d';
                        selectedMonitor.style.boxShadow = '0 0 20px #ff2e6d';
                        setTimeout(() => {
                            selectedMonitor.style.color = '';
                            selectedMonitor.style.borderColor = '';
                            selectedMonitor.style.boxShadow = '';
                        }, 500);
                    }
                    startCodeRowSpin();
                    isUSBActive = false;
                    usb.classList.remove('active');
                    activeShieldIndex = -1;
                    correctBoxIndex = -1;
                    document.querySelectorAll('.shield-icon').forEach(shield => shield.classList.remove('active-cyan'));
                    document.querySelectorAll('.monitor-vertical-wire').forEach(wire => wire.classList.remove('cable-glow'));
                }
            } else {
                // Stage-2 mantığı
                checkPasswordStage2();
            }
        });

        // Stage-2 için şifre kontrolü
        function checkPasswordStage2() {
            const passwordMonitors = document.querySelectorAll('.password-monitor');
            const codeMonitors = document.querySelectorAll('.code-monitor');
            const targetChar = passwordMonitors[selectedMonitorIndex].textContent;
            const currentChar = codeMonitors[selectedMonitorIndex].textContent;

            // Çözülmüş kutuyu tekrar kontrol etme
            if (unlockedBoxes.includes(selectedMonitorIndex)) return;

            if (targetChar === currentChar) {
                // Doğru eşleşme
                passwordMonitors[selectedMonitorIndex].style.color = '#00ffff';  // Cyan
                codeMonitors[selectedMonitorIndex].style.color = '#00ffff';     // Cyan
                codeMonitors[selectedMonitorIndex].style.borderColor = '#00ffff'; // Cyan
                codeMonitors[selectedMonitorIndex].style.boxShadow = '0 0 10px #00ffff';
                
                // Bu kutuyu çözülmüş olarak işaretle
                unlockedBoxes.push(selectedMonitorIndex);
                unlockedPasswordCount++;

                // Dönüşü durdur
                if (codeRowSpinIntervals[selectedMonitorIndex]) {
                    clearInterval(codeRowSpinIntervals[selectedMonitorIndex]);
                    codeRowSpinIntervals[selectedMonitorIndex] = null;
                }

                // Tüm şifreler çözüldü mü kontrol et
                if (unlockedPasswordCount === 9) {
                    setTimeout(() => endGame(true), 500);
                    return;
                }

                // Otomatik olarak bir sonraki çözülmemiş kutuya geç
                if (selectedMonitorIndex < 8) {
                    selectedMonitorIndex++;
                    // Çözülmüş kutuları atla
                    while (selectedMonitorIndex < 9 && unlockedBoxes.includes(selectedMonitorIndex)) {
                        selectedMonitorIndex++;
                    }
                    // Eğer sağda çözülmemiş kutu yoksa, en baştaki çözülmemiş kutuya git
                    if (selectedMonitorIndex >= 9) {
                        selectedMonitorIndex = 0;
                        while (selectedMonitorIndex < 9 && unlockedBoxes.includes(selectedMonitorIndex)) {
                            selectedMonitorIndex++;
                        }
                    }
                    updateSelection();
                }

                isUSBActive = false;
                usb.classList.remove('active');
            } else {
                // Yanlış eşleşme
                codeMonitors[selectedMonitorIndex].style.color = '#ff2e6d';
                codeMonitors[selectedMonitorIndex].style.borderColor = '#ff2e6d';
                codeMonitors[selectedMonitorIndex].style.boxShadow = '0 0 20px #ff2e6d';
                setTimeout(() => {
                    codeMonitors[selectedMonitorIndex].style.color = '';
                    codeMonitors[selectedMonitorIndex].style.borderColor = '';
                    codeMonitors[selectedMonitorIndex].style.boxShadow = '';
                }, 500);

                // Dönüşü durdur (kullanıcı USB ile tekrar başlatacak)
                if (codeRowSpinIntervals[selectedMonitorIndex]) {
                    clearInterval(codeRowSpinIntervals[selectedMonitorIndex]);
                    codeRowSpinIntervals[selectedMonitorIndex] = null;
                }

                isUSBActive = false;
                usb.classList.remove('active');
            }
        }

        // Klavye kontrolleri
        document.addEventListener('keydown', (e) => {
            if (!gameStarted) return;

            switch(e.key) {
                case 'ArrowLeft':
                    leftBtn.click();
                    break;
                case 'ArrowRight':
                    rightBtn.click();
                    break;
                case ' ':
                    usb.click();
                    break;
                case 'Enter':
                    connectBtn.click();
                    break;
            }
        });

        // Touch olayları için swipe desteği
        let touchStartX = 0;
        document.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
        });

        document.addEventListener('touchend', (e) => {
            if (!gameStarted) return;
            
            const touchEndX = e.changedTouches[0].clientX;
            const diffX = touchEndX - touchStartX;

            if (Math.abs(diffX) > 50) { // minimum swipe mesafesi
                if (diffX > 0) {
                    rightBtn.click();
                } else {
                    leftBtn.click();
                }
            }
        });

        // Ekran boyutu değişirse kabloları ve kalkanları yeniden konumlandır
        window.addEventListener('resize', () => {
            setTimeout(() => {
                positionVerticalWires();
                positionShields();
            }, 0);
        });

        // Her passwordRow-codeRow monitör çifti için dikey kablo çiz
        function positionVerticalWires() {
            // Eski kabloları temizle
            document.querySelectorAll('.monitor-vertical-wire').forEach(wire => wire.remove());
            document.querySelectorAll('.shield-icon').forEach(icon => icon.remove());
            document.querySelectorAll('.shield-down-wire').forEach(wire => wire.remove());
            const passwordMonitors = passwordRow.children;
            const codeMonitors = codeRow.children;
            const container = document.getElementById('gameContainer');

            for (let i = 0; i < passwordMonitors.length; i++) {
                const topBox = passwordMonitors[i].getBoundingClientRect();
                const bottomBox = codeMonitors[i].getBoundingClientRect();
                const containerBox = container.getBoundingClientRect();

                // Başlangıç noktası: üst kutunun alt merkezi
                const startX = topBox.left + topBox.width / 2 - containerBox.left;
                const startY = topBox.bottom - containerBox.top;
                // Bitiş noktası: alt kutunun üst merkezi
                const endY = bottomBox.top - containerBox.top;
                const height = endY - startY;

                // Kabloyu oluştur
                const wire = document.createElement('div');
                wire.className = 'monitor-vertical-wire';
                wire.style.left = `${startX - 1}px`;
                wire.style.top = `${startY}px`;
                wire.style.height = `${height}px`;
                container.appendChild(wire);
            }

            // Shield ikonlarını iki kablonun arasına ve ortalanmış şekilde ekle (toplam 8 adet)
            for (let i = 0; i < passwordMonitors.length - 1; i++) {
                const topBox1 = passwordMonitors[i].getBoundingClientRect();
                const topBox2 = passwordMonitors[i+1].getBoundingClientRect();
                const bottomBox1 = codeMonitors[i].getBoundingClientRect();
                const bottomBox2 = codeMonitors[i+1].getBoundingClientRect();
                const containerBox = container.getBoundingClientRect();

                // İki üst kutunun alt merkezlerinin ortası
                const startX1 = topBox1.left + topBox1.width / 2 - containerBox.left;
                const startX2 = topBox2.left + topBox2.width / 2 - containerBox.left;
                const midX = (startX1 + startX2) / 2;

                // Üst ve alt kutuların ortası (dikeyde)
                const startY = topBox1.bottom - containerBox.top;
                const endY = bottomBox1.top - containerBox.top;
                const midY = (startY + endY) / 2;

                // Shield ikonunu oluştur
                const shield = document.createElement('div');
                shield.className = 'shield-icon';
                shield.style.left = `${midX - 14}px`;
                shield.style.top = `${midY - 14}px`;
                shield.innerHTML = `<svg viewBox="0 0 28 28"><path class="shield-shape" d="M14 3 L24 7 Q23 18 14 25 Q5 18 4 7 Z"/></svg>`;
                container.appendChild(shield);

                // Shield'ın alt merkezinden cyan çizgiye kadar beyaz kablo çiz
                // Shield'ın alt merkezi
                const shieldBottomY = midY + 14; // shield yüksekliği/2
                const shieldCenterX = midX;

                // Kontrol paneli separator çizgisinin konumunu bul
                const separator = document.querySelector('.control-separator');
                if (separator) {
                    const sepRect = separator.getBoundingClientRect();
                    const sepY = sepRect.top - containerBox.top;
                    // Kablonun uzunluğu: shield'ın altından separator çizgisinin biraz altına kadar
                    const wireLength = sepY + 6 - shieldBottomY; // 6px aşağı taşsın
                    const downWire = document.createElement('div');
                    downWire.className = 'shield-down-wire';
                    downWire.style.left = `${shieldCenterX - 0.5}px`;
                    downWire.style.top = `${shieldBottomY}px`;
                    downWire.style.height = `${wireLength}px`;
                    container.appendChild(downWire);
                }
            }
        }

        // JS: Oyun süresi ile antivirüs süresini senkronize et
        function updateAntivirusTimeDisplay() {
            document.getElementById('antivirusTime').textContent = antivirusTime;
        }

        // ===== Tutorial Data =====
        const tutorialSlides = [
            { title: "Hedef", text: "Şüpheli cihazın şifresini kır ve dijital delillere ulaş! Her aşama için zamanın kısıtlı." },
            { title: "Zaman", text: "Antivirüs çemberi süreni gösterir. Stage-1: 60 sn, Stage-2: 90 sn." },
            { title: "USB", text: "USB butonuna basarak kod döngüsünü başlat/durdur. Stage-1 ve Stage-2'de farklı işlevi var." },
            { title: "Ok Tuşları", text: "Sağ/sol oklarla kutular arasında gez. Mobilde butonları kullanabilirsin." },
            { title: "Bağlan", text: "Seçili kutuda doğru karakteri bulduğunda 'BAĞLAN' ile kilitle." },
            { title: "Stage-1 Kuralı", text: "USB'ye basınca rastgele bir shield aktif olur. Sadece o iki kutudan birini seçebilirsin." },
            { title: "Stage-2 Kuralı", text: "Üst satırdaki karakterleri tek tek eşleştir. USB ile döngüyü durdur, doğru karakteri bulunca BAĞLAN'a bas." }
        ];
        let tutorialIndex = 0;
        let tutorialDone = false;

        function showTutorial() {
            const modal = document.getElementById('tutorialModal');
            modal.style.display = 'flex';
            updateTutorialSlide();
        }
        function hideTutorial() {
            document.getElementById('tutorialModal').style.display = 'none';
            tutorialDone = true;
            // Oyun başlatılacaksa burada başlatılır
            setTimeout(() => { startGame(); }, 0);
        }
        function updateTutorialSlide() {
            const slide = tutorialSlides[tutorialIndex];
            document.getElementById('tutorialTitle').textContent = slide.title;
            document.getElementById('tutorialText').textContent = slide.text;
            document.getElementById('tutorialPrev').disabled = tutorialIndex === 0;
            document.getElementById('tutorialNext').textContent = tutorialIndex === tutorialSlides.length - 1 ? '✔' : '→';
        }
        document.getElementById('tutorialPrev').onclick = function() {
            if (tutorialIndex > 0) { tutorialIndex--; updateTutorialSlide(); }
        };
        document.getElementById('tutorialNext').onclick = function() {
            if (tutorialIndex < tutorialSlides.length - 1) {
                tutorialIndex++;
                updateTutorialSlide();
            } else {
                hideTutorial();
            }
        };
        document.getElementById('tutorialSkip').onclick = function() { hideTutorial(); };
        // Klavye ile gezinme
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('tutorialModal').style.display === 'flex') {
                if (e.key === 'ArrowLeft') document.getElementById('tutorialPrev').click();
                if (e.key === 'ArrowRight') document.getElementById('tutorialNext').click();
                if (e.key === 'Escape') hideTutorial();
            }
        });
        // Oyun başında otomatik aç
        window.addEventListener('DOMContentLoaded', function() {
            if (!tutorialDone) showTutorial();
        });

        // Son seçili kutu indeksini tut
        let lastSelectedIndex = 0;

        // Stage-2 için üst sıra şifrelerini ayarla
        function setupStage2Passwords() {
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
            const numbers = '0123456789'.split('');
            const passwordMonitors = document.querySelectorAll('.password-monitor');
            
            // 5 harf ve 4 rakam seçeceğiz
            let selectedChars = [];
            
            // 5 farklı harf seç
            while(selectedChars.length < 5) {
                const randomLetter = letters[Math.floor(Math.random() * letters.length)];
                if (!selectedChars.includes(randomLetter)) {
                    selectedChars.push(randomLetter);
                }
            }
            
            // 4 farklı rakam seç
            while(selectedChars.length < 9) {
                const randomNumber = numbers[Math.floor(Math.random() * numbers.length)];
                if (!selectedChars.includes(randomNumber)) {
                    selectedChars.push(randomNumber);
                }
            }
            
            // Karakterleri karıştır
            for (let i = selectedChars.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [selectedChars[i], selectedChars[j]] = [selectedChars[j], selectedChars[i]];
            }
            
            // Üst monitörlere yerleştir ve karakterleri sakla
            passwordMonitors.forEach((monitor, index) => {
                monitor.textContent = selectedChars[index];
                monitor.style.color = '#00ffff'; // Cyan renk
                // Her monitörün karakter tipini sakla
                monitor.dataset.type = /[A-Z]/.test(selectedChars[index]) ? 'letter' : 'number';
            });

            console.log('Üst sıra karakterleri:', selectedChars);
        }

        // Stage-2 için sıralı spin
        function startCodeRowSpinStage2() {
            stopCodeRowSpin();
            isSpinning = true;
            const codeMonitors = codeRow.children;
            const passwordMonitors = document.querySelectorAll('.password-monitor');

            // Hızları sadece ilk kez oluştur
            if (boxSpeeds.length === 0) {
                boxSpeeds = Array.from({length: 9}, (_, i) => 100 + (i * 30));
                for (let i = boxSpeeds.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [boxSpeeds[i], boxSpeeds[j]] = [boxSpeeds[j], boxSpeeds[i]];
                }
                console.log('Kutu hızları (ms):', boxSpeeds);
            }

            startBoxSpin();
        }

        // Tek bir kutuyu döndürmeye başlat
        function startBoxSpin(index = null) {
            const codeMonitors = codeRow.children;
            const passwordMonitors = document.querySelectorAll('.password-monitor');

            // Tüm kutular için
            if (index === null) {
                for (let i = 0; i < codeMonitors.length; i++) {
                    if (!unlockedBoxes.includes(i)) {
                        startSingleBoxSpin(i);
                    }
                }
            }
            // Tek kutu için
            else if (!unlockedBoxes.includes(index)) {
                startSingleBoxSpin(index);
            }
        }

        // Tek bir kutunun dönüşünü başlat
        function startSingleBoxSpin(index) {
            const codeMonitor = codeRow.children[index];
            const passwordMonitor = document.querySelectorAll('.password-monitor')[index];
            const isLetter = passwordMonitor.dataset.type === 'letter';
            const sequence = isLetter ? 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' : '0123456789';

            if (codeRowSpinIntervals[index]) {
                clearInterval(codeRowSpinIntervals[index]);
            }

            codeRowSpinIntervals[index] = setInterval(() => {
                codeMonitor.textContent = sequence[currentCharIndices[index]];
                currentCharIndices[index] = (currentCharIndices[index] + 1) % sequence.length;
            }, boxSpeeds[index]);
        }

        // Tek bir kutunun dönüşünü durdur
        function stopBoxSpin(index) {
            if (codeRowSpinIntervals[index]) {
                clearInterval(codeRowSpinIntervals[index]);
                codeRowSpinIntervals[index] = null;
            }
        }

        // Stage-2 için tutorial
        function showTutorial2() {
            const tutorialSlides = [
                { title: "Stage 2", text: "Bu aşamada her kutu bağımsız çalışır. Shield sistemi devre dışıdır." },
                { title: "Şifreler", text: "Üst sırada 5 harf ve 4 rakam karışık olarak yerleştirilmiştir." },
                { title: "Kontrol", text: "Her kutu için ayrı ayrı USB ile döngüyü kontrol edebilirsiniz." },
                { title: "Eşleştirme", text: "Üstteki karakterle alttaki karakteri eşleştirmeniz gerekiyor." },
                { title: "Süre", text: "Bu aşama için 90 saniye süreniz var. İyi şanslar!" }
            ];
            
            let currentSlide = 0;
            const modal = document.getElementById('tutorialModal');
            const title = document.getElementById('tutorialTitle');
            const text = document.getElementById('tutorialText');
            const nextBtn = document.getElementById('tutorialNext');
            const prevBtn = document.getElementById('tutorialPrev');
            
            function updateSlide() {
                title.textContent = tutorialSlides[currentSlide].title;
                text.textContent = tutorialSlides[currentSlide].text;
                prevBtn.style.visibility = currentSlide === 0 ? 'hidden' : 'visible';
                nextBtn.textContent = currentSlide === tutorialSlides.length - 1 ? '✔' : '→';
            }
            
            modal.style.display = 'flex';
            updateSlide();
            
            nextBtn.onclick = () => {
                if (currentSlide < tutorialSlides.length - 1) {
                    currentSlide++;
                    updateSlide();
                } else {
                    modal.style.display = 'none';
                    startTimer(90);
                }
            };
            
            prevBtn.onclick = () => {
                if (currentSlide > 0) {
                    currentSlide--;
                    updateSlide();
                }
            };
            
            document.getElementById('tutorialSkip').onclick = () => {
                modal.style.display = 'none';
                startTimer(90);
            };
        }
    </script>
</body>
</html> 
