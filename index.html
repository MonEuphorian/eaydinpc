<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CSI Kod Kırma Görevi</title>
    <style>
        /* Temel Stil */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
            user-select: none;
            -webkit-user-select: none;
        }
        
        body {
            background-color: #0a0a0a;
            color: #33ff33;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            padding: 15px;
            position: relative;
        }
        
        /* Matrix benzeri arka plan */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(0, 0, 0, 0.97), rgba(0, 0, 0, 0.97)), 
                        url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Ctext x='10' y='20' fill='rgba(51, 255, 51, 0.1)' font-family='monospace'%3E01%3C/text%3E%3Ctext x='60' y='40' fill='rgba(51, 255, 51, 0.1)' font-family='monospace'%3E10%3C/text%3E%3Ctext x='30' y='60' fill='rgba(51, 255, 51, 0.1)' font-family='monospace'%3E01%3C/text%3E%3Ctext x='70' y='80' fill='rgba(51, 255, 51, 0.1)' font-family='monospace'%3E10%3C/text%3E%3C/svg%3E");
            z-index: -1;
        }
        
        /* Başlık - kaldırıldı */
        /* .title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 0 10px #33ff33;
        } */
        
        /* Game Container - Yatay ekran için genişletildi */
        .game-container {
            width: 100%;
            max-width: 800px; /* Temel genişlik */
            background-color: rgba(17, 17, 17, 0.95);
            border: 2px solid #33ff33;
            border-radius: 10px;
            padding: 30px; /* Daha fazla iç boşluk */
            box-shadow: 0 0 20px rgba(51, 255, 51, 0.3);
            position: relative;
        }
        
        /* Oyun Başlığı - Container içinde - Kaldırıldı */
        /* .game-title {
            font-size: 1.2rem;
            text-align: center;
            margin-bottom: 15px;
            text-shadow: 0 0 10px #33ff33;
        } */
        
        /* Timer */
        .timer {
            position: absolute;
            bottom: 20px;
            right: 20px;
            font-size: 2rem; /* Daha büyük zaman göstergesi */
            color: #33ff33; /* Başlangıç rengi yeşil */
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: bold;
        }
        
        /* Status - Kaldırıldı */
        /* .status {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.2rem;
        } */
        
        /* Rows */
        .password-row, .code-row {
            display: flex;
            justify-content: space-between;
        }
        
        .password-row {
            margin-bottom: 70px; /* Üst ve alt kutular arasındaki mesafeyi artırdım */
            margin-top: 20px; /* Üst kutuların üstündeki boşluğu artır */
        }
        
        .code-row {
            margin-bottom: 30px; /* Alt kutularla butonlar arası mesafeyi artır */
        }
        
        /* Boxes - Daha büyük kutular ve responsive */
        .box {
            width: 60px; /* Temel genişlik */
            height: 60px; /* Temel yükseklik */
            background-color: #000;
            border: 3px solid #33ff33; /* Daha kalın kenarlık */
            border-radius: 8px; /* Hafif yuvarlatılmış köşeler */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem; /* Daha büyük yazı boyutu */
            position: relative;
            transition: all 0.3s ease;
        }
        
        .password-box {
            color: #fff;
            background-color: #222;
            position: relative;
        }
        
        .password-box::after {
            content: '';
            position: absolute;
            width: 2px; /* Çizgi kalınlığı */
            background-color: rgba(50, 50, 50, 0.7); /* Koyu gri çizgi rengi */
            top: 100%; /* Kutunun alt kenarından başla */
            left: 50%; /* Kutunun yatay ortasından */
            transform: translateX(-50%); /* Tam ortadan hizala */
            height: calc(var(--box-spacing) - 0px); /* Üst ve alt kutular arası mesafe */
            z-index: 1; /* Çizgiyi diğer elementlerin üzerine çıkar */
        }
        
        .password-box.solved::after {
            background-color: rgba(50, 50, 50, 0.7); /* Çözülmüş kutular için de koyu gri */
        }
        
        .spinning {
            overflow: hidden;
        }
        
        .spinner {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* Shield */
        .shield {
            position: absolute;
            width: 100%;
            height: 70px; /* Daha yüksek shield */
            background-color: rgba(255, 255, 0, 0.2);
            border: 2px solid yellow;
            border-radius: 5px;
            z-index: 1;
            display: none;
        }
        
        /* Control buttons */
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px; /* Butonlar arası daha fazla boşluk */
            margin-bottom: 20px;
        }
        
        .btn {
            background-color: #111;
            color: #33ff33;
            border: 3px solid #33ff33; /* Daha kalın kenarlık */
            border-radius: 8px;
            padding: 12px 25px; /* Daha büyük butonlar */
            font-size: 1.2rem; /* Daha büyük yazı boyutu */
            cursor: pointer;
            transition: all 0.3s;
            outline: none;
            touch-action: manipulation;
        }
        
        .btn:hover, .btn:active {
            background-color: #222;
            box-shadow: 0 0 10px rgba(51, 255, 51, 0.5);
        }
        
        /* Aktif buton vurgusu */
        .btn-active {
            background-color: #222;
            box-shadow: 0 0 15px rgba(51, 255, 51, 0.7);
        }
        
        /* Game screens */
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 999;
            padding: 20px;
            text-align: center;
            overflow-y: auto; /* İçerik sığmazsa scroll çubuğu göster */
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Selected box */
        .selected {
            border-color: yellow;
            box-shadow: 0 0 15px rgba(255, 255, 0, 0.7); /* Daha parlak seçim vurgusu */
        }
        
        /* Success and error indicators */
        .success {
            border-color: #00ff00;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.7); /* Daha parlak başarı vurgusu */
        }
        
        .error {
            border-color: #ff0000;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.7); /* Daha parlak hata vurgusu */
        }

        /* Yeni eklenen stil - parlayan çiftler ve çözülmüş kutu */
        .highlight {
            border-color: #ffff00;
            box-shadow: 0 0 15px rgba(255, 255, 0, 0.7);
        }

        .solved {
            color: #00ffff !important; /* Karakter rengi turkuaz kalacak */
        }

        .temp-solved-border {
            border-color: #00ffff;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.7);
        }

        /* Animasyonlar */
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        
        @keyframes shield-blink {
            0% { opacity: 0.7; }
            50% { opacity: 0.3; }
            100% { opacity: 0.7; }
        }
        
        .shield {
            animation: shield-blink 0.8s infinite;
        }

        /* Çözüm durumundaki geçiş efekti için animasyon */
        @keyframes connection-success {
            0% { background-color: rgba(50, 50, 50, 0.7); } /* Koyu gri başlangıç */
            50% { background-color: rgba(51, 255, 51, 0.7); } /* Yeşil vurgu */
            100% { background-color: rgba(50, 50, 50, 0.7); } /* Koyu gri bitiş */
        }

        /* Bu stil, çözüm durumunda kutular arasındaki bağlantı çizgisinin animasyonunu sağlar */
        .password-box.success::after {
            animation: connection-success 1s forwards;
        }

        /* Kilit İkonu */
        .lock-icon {
            position: absolute;
            width: 24px;
            height: 24px;
            z-index: 5; /* Bağlantı çizgilerinin üzerinde */
            opacity: 0.7;
            display: none; /* Başlangıçta gizli */
            transform: translate(-50%, -50%); /* Tam merkeze hizala */
            transition: all 0.3s ease;
        }

        /* Kilit ikonu içindeki SVG */
        .lock-icon svg {
            width: 100%;
            height: 100%;
            fill: #555;
            stroke: #33ff33;
            stroke-width: 1px;
            transition: all 0.3s ease;
        }

        /* Aktif kilit ikonu */
        .lock-icon.active {
            display: block;
        }
        
        /* Vurgulanan kilit ikonu */
        .lock-icon.highlight svg {
            fill: #333;
            stroke: #ffff00;
            stroke-width: 2px;
            filter: drop-shadow(0 0 5px rgba(255, 255, 0, 0.7));
        }
        
        /* Çözülmüş kilit ikonu - rengini değiştirmiyoruz */
        .lock-icon.solved svg {
            fill: #555; /* Orijinal fill rengi korundu */
            stroke: #33ff33; /* Orijinal stroke rengi korundu */
            stroke-width: 1px; /* Orijinal çizgi kalınlığı korundu */
        }
        
        /* Responsive kilit boyutları */
        @media (min-width: 1200px) {
            .lock-icon {
                width: 28px;
                height: 28px;
            }
        }
        
        @media (max-width: 600px) {
            .lock-icon {
                width: 20px;
                height: 20px;
            }
        }
        
        @media (max-width: 450px) {
            .lock-icon {
                width: 16px;
                height: 16px;
            }
        }

        /* Başlangıç ekranı için genel ayarlamalar */
        #start-screen {
            padding: 20px;
            justify-content: center;
        }

        #start-content {
            display: none;
        }

        /* Yatay ekran için ek optimizasyonlar */
        @media (orientation: landscape) {
            .game-container {
                max-width: 95vw; /* Daha geniş alan */
                max-height: 92vh; /* Maksimum yükseklik */
                padding: 25px 35px 25px 35px; /* Yatay ve dikey padding */
                display: flex;
                flex-direction: column;
                justify-content: space-between;
            }
            
            body {
                padding: 0;
            }
            
            .box {
                width: 65px; /* Yatay ekranda biraz daha büyük kutular */
                height: 65px;
            }
            
            .password-row {
                margin-bottom: 80px; /* Üst ve alt kutular arasındaki mesafeyi daha fazla artırdım */
                margin-top: 5px; /* Üst kutuları daha yukarıya taşı */
            }
            
            .code-row {
                margin-bottom: 20px; /* Alt kutularla buton arasındaki mesafeyi azalt */
            }
            
            .stage-indicator {
                bottom: 10px;
                left: 20px;
                font-size: 0.9rem;
            }
            
            .timer {
                bottom: 10px;
                right: 20px;
                font-size: 2.2rem;
            }
            
            .controls {
                margin-top: 10px; /* Butonların alttan mesafesini azalt */
                margin-bottom: 20px; /* Butonların alttan mesafesini ayarla */
            }
            
            /* Başlangıç ekranı, kazanma ekranı ve diğer ekranlar için ayarlar */
            .screen {
                padding: 15px;
            }
        }

        /* Küçük ekranlar için kutu boyutları */
        @media (max-width: 600px) {
            .box {
                width: 50px;
                height: 50px;
                font-size: 1.8rem;
            }
            
            .stage-indicator, .timer {
                font-size: 1rem;
                padding: 6px 10px;
            }
        }
        
        /* Çok küçük ekranlar için daha da küçük kutular */
        @media (max-width: 450px) {
            .box {
                width: 40px;
                height: 40px;
                font-size: 1.5rem;
                border-width: 2px;
            }
            
            .password-row {
                margin-bottom: 20px;
                margin-top: 30px;
            }
            
            .controls .btn {
                padding: 8px 15px;
                font-size: 1rem;
            }
        }

        /* Aşama 2 için özel buton stil */
        .connect-stage2 {
            background-color: #333;
            color: #00ffff;
            border-color: #00ffff;
        }
        
        /* Pulse animasyonu - vurguyu arttırıyoruz */
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.9; } /* Scale değerini artırdık */
            100% { transform: scale(1); opacity: 1; }
        }

        /* Etap tamamlandı göstergesi */
        .stage-indicator {
            position: absolute;
            bottom: 20px;
            left: 20px;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 1rem;
            color: #888;
        }
        
        /* Final animasyonu için etki */
        @keyframes glitch {
            0% { transform: translate(0); text-shadow: 0 0 0 #00ffff; }
            2% { transform: translate(-2px, 2px); text-shadow: -2px 2px 0 #ff00ff; }
            4% { transform: translate(2px, -2px); text-shadow: 2px -2px 0 #ff0000; }
            6% { transform: translate(0); text-shadow: 0 0 0 #00ffff; }
            100% { transform: translate(0); text-shadow: 0 0 0 #00ffff; }
        }
        
        .glitch-effect {
            animation: glitch 2s infinite;
        }
        
        .highlight {
            border-color: #ffff00;
            box-shadow: 0 0 15px rgba(255, 255, 0, 0.7);
            animation: highlight-pulse 1.5s infinite;
        }
        
        @keyframes highlight-pulse {
            0% { box-shadow: 0 0 15px rgba(255, 255, 0, 0.7); }
            50% { box-shadow: 0 0 25px rgba(255, 255, 0, 0.9); }
            100% { box-shadow: 0 0 15px rgba(255, 255, 0, 0.7); }
        }

        /* Geniş ekranlar için özel ayarlar */
        @media (min-width: 1200px) {
            .game-container {
                max-width: 1000px; /* Çok geniş ekranlarda daha da geniş */
            }
            
            .box {
                width: 70px; /* Geniş ekranlarda daha büyük kutular */
                height: 70px;
                font-size: 2.2rem;
            }
        }

        /* Çok büyük ekranlar için Game Container'ı yükselt */
        @media (min-height: 800px) {
            .game-container {
                padding: 40px 30px; /* Dikey pad artır */
            }
            
            .password-row {
                margin-bottom: 100px; /* Üst ve alt kutular arasındaki mesafeyi daha da artır */
                margin-top: 20px; /* Üst kutuların üst kenar boşluğunu artır */
            }
            
            .code-row {
                margin-bottom: 40px; /* Alt sıra ile buton arası mesafeyi artır */
            }
            
            .box {
                width: 70px; /* Kutuları biraz daha büyüt */
                height: 70px;
            }
        }

        /* Full-height Game Container için düzenleme */
        @media (min-height: 900px) and (orientation: landscape) {
            .game-container {
                max-height: 95vh; /* Daha da büyük yükseklik */
                display: flex;
                flex-direction: column;
                justify-content: center; /* Dikey ortala */
                align-items: center; /* Yatay ortala */
                padding: 50px 40px; /* Daha fazla padding */
            }
            
            .box {
                width: 75px;
                height: 75px;
                font-size: 2.2rem;
            }
            
            .password-row {
                margin-bottom: 120px; /* Daha fazla boşluk - alt kutuları daha aşağıya taşıdım */
            }
            
            .code-row {
                margin-bottom: 50px;
            }
            
            .controls .btn {
                padding: 15px 30px;
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Başlangıç Ekranı -->
    <div id="start-screen" class="screen">
        <h1 style="color: #33ff33; margin-bottom: 20px; font-size: 2.5rem; text-shadow: 0 0 10px rgba(51, 255, 51, 0.5);">CSI Kod Kırma Görevi</h1>
        
        <p style="margin-bottom: 15px; font-size: 1.3rem;">Kilit ikonlarını takip ederek kutuları seç ve şifreyi çöz.</p>
        <p style="margin-bottom: 25px; font-size: 1.3rem;">Görev süresi kısıtlı, hızlı ve dikkatli ol!</p>
        
        <!-- Yatay ekran uyarısı -->
        <div style="background-color: rgba(255, 153, 0, 0.2); border: 2px solid #ff9900; padding: 15px; border-radius: 8px; margin-bottom: 25px;">
            <p style="color: #ff9900; font-size: 1.3rem; margin: 0;"><strong>⚠️</strong> En iyi deneyim için cihazınızı yatay konumda kullanınız!</p>
        </div>
        
        <button id="start-btn" class="btn" onclick="startGame()">GÖREVİ BAŞLAT</button>
    </div>

    <!-- Oyun Alanı -->
    <!-- <h1 class="title">CSI Kod Kırma Operasyonu</h1> --> <!-- Başlık kaldırıldı -->
    <div class="game-container">
        <!-- Aşama göstergesi -->
        <div class="stage-indicator" id="stage-indicator">AŞAMA 1/2</div>
        <div class="timer">60</div>
        
        <!-- Kilit İkonu Container - Bağlantı çizgileri arasındaki kilit ikonları -->
        <div id="lock-container"></div>
        
        <div class="shield" id="shield"></div>
        
        <!-- Password Row - üst sıra -->
        <div class="password-row" id="password-row">
            <!-- 9 kutu JavaScript ile eklenecek -->
        </div>
        
        <!-- Code Row - alt sıra -->
        <div class="code-row" id="code-row">
            <!-- 9 kutu JavaScript ile eklenecek -->
        </div>
        
        <!-- Kontrol Butonları -->
        <div class="controls">
            <button id="connect-btn" class="btn">CONNECT</button>
        </div>
    </div>
    
    <!-- Aşama Tamamlandı Ekranı -->
    <div id="stage-complete" class="screen hidden">
        <h2 style="color: #33ff33; margin-bottom: 20px; font-size: 2.2rem;">Güvenlik Denetimi Aşıldı!</h2>
        <p style="margin-bottom: 25px; font-size: 1.3rem;">Şimdi şifre dizisini çözme zamanı.</p>
        <button id="next-stage-btn" class="btn" onclick="startStage2()">2. AŞAMAYA GEÇ</button>
    </div>
    
    <!-- Oyun Sonu Ekranı -->
    <div id="win-screen" class="screen hidden">
        <h2 style="color: #33ff33; margin-bottom: 20px; font-size: 2.2rem;">GÖREVİ TAMAMLADIN!</h2>
        <p style="margin-bottom: 15px; font-size: 1.3rem;">Tebrikler! Kod başarıyla kırıldı ve delillere ulaşıldı.</p>
        <div style="background: #111; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <p id="clue" style="color: #ff9900; font-size: 1.5rem;">Dosya konumu: /gizli/deliller/dosya451.bin</p>
        </div>
        <button id="restart-btn" class="btn" onclick="initGame(); winScreen.classList.add('hidden');">YENİDEN BAŞLAT</button>
    </div>
    
    <!-- Süre Doldu Ekranı -->
    <div id="time-up" class="screen hidden">
        <h2 style="color: #ff3333; margin-bottom: 20px; font-size: 2.2rem;">SÜRE DOLDU!</h2>
        <p style="margin-bottom: 25px; font-size: 1.3rem;">Güvenlik sistemi tehdidi algıladı ve kendini yeniden başlattı.</p>
        
        <!-- 2. aşamada bilgi gösterecek yer -->
        <p id="retry-message" style="color: #00ffff; margin-bottom: 25px; font-size: 1.3rem; display: none;"></p>
        
        <button id="retry-btn" class="btn" onclick="timeUpScreen.classList.add('hidden'); if(currentStage === 1) { initGame(); } else { startStage2(); }">TEKRAR DENE</button>
    </div>

    <script>
        // Oyun Değişkenleri
        let currentStage = 1; // 1: İlk aşama, 2: İkinci aşama
        let timer = currentStage === 1 ? 60 : 90; // Süre (saniye)
        let timerInterval;
        let selectedBoxIndex = 0; // Seçili kutu indeksi
        let passwordRow = []; // Şifre satırı
        let characterSets = []; // Her kutu için olası karakterler
        let spinningIntervals = []; // Dönen kutuların interval'leri
        let correctBoxes = []; // Doğru tahmin edilen kutular
        let isSpinning = true; // Döngü durumu
        let highlightedBoxes = []; // Parlayan kutu çifti
        let correctBox = null; // Doğru kutu
        let selectedBox = null; // 2. aşama için seçilen kutu
        let boxStates = []; // Her kutunun durumu (dönen/duran)
        let boxSpeeds = null; // Her kutunun dönme hızı (2. aşama için)
        let charIndices = null; // Her kutunun mevcut karakter indeksi (2. aşama için)
        let finalCharacters = ['E', 'A', 'Y', 'D', 'I', 'N', '1', '2', '3']; // Final animasyonu için karakterler
        
        // DOM Elementleri
        const passwordRowEl = document.getElementById('password-row');
        const codeRowEl = document.getElementById('code-row');
        const timerEl = document.querySelector('.timer');
        const shieldEl = document.getElementById('shield');
        const connectBtn = document.getElementById('connect-btn');
        const stageIndicator = document.getElementById('stage-indicator');
        
        // Ekran elementleri
        const startScreen = document.getElementById('start-screen');
        const stageCompleteScreen = document.getElementById('stage-complete');
        const winScreen = document.getElementById('win-screen');
        const timeUpScreen = document.getElementById('time-up');
        
        // Butonlar
        const startBtn = document.getElementById('start-btn');
        const nextStageBtn = document.getElementById('next-stage-btn');
        const restartBtn = document.getElementById('restart-btn');
        const retryBtn = document.getElementById('retry-btn');
        
        // Olası karakterler
        const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        const lettersOnly = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        const numbersOnly = '0123456789';
        
        // Oyunu başlat
        function startGame() {
            startScreen.classList.add('hidden');
            initGame();
        }
        
        // Pencere yüklendiğinde ve yeniden boyutlandığında çağrılacak
        function handleResize() {
            checkOrientation();
            updateConnectorLines();
            
            // Kilit ikonlarını yeniden konumlandır
            if (currentStage === 1) {
                createLockIcons();
            }
        }
        
        // Oyunu başlat
        function initGame() {
            // Aşama göstergesini güncelle
            stageIndicator.textContent = "AŞAMA 1/2";
            
            // Password row oluştur (üst sıra)
            passwordRowEl.innerHTML = '';
            for (let i = 0; i < 9; i++) {
                const box = document.createElement('div');
                box.className = 'box password-box';
                box.textContent = '?';
                passwordRowEl.appendChild(box);
            }
            
            // Code row oluştur (alt sıra)
            codeRowEl.innerHTML = '';
            for (let i = 0; i < 9; i++) {
                const box = document.createElement('div');
                box.className = 'box spinning';
                box.innerHTML = '<div class="spinner">?</div>';
                box.dataset.index = i; // Tıklama için indeks ekle
                
                // Kutuya tıklama olayı ekle
                box.addEventListener('click', function() {
                    handleBoxClick(i);
                });
                
                codeRowEl.appendChild(box);
            }
            
            // Her kutu için rastgele karakter seti oluştur
            characterSets = [];
            for (let i = 0; i < 9; i++) {
                // Her kutu için olası karakterleri karıştır
                characterSets.push(shuffleString(characters));
            }
            
            // Doğru şifre oluştur (rastgele)
            passwordRow = [];
            for (let i = 0; i < 9; i++) {
                const randomIndex = Math.floor(Math.random() * characters.length);
                passwordRow.push(characters[randomIndex]);
            }
            
            // Kutular için spinning efekti başlat
            startSpinning();
            
            // İlk aşama için süreyi ayarla
            timer = 60;
            updateTimer();
            
            // Timer'ı başlat
            clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);
            
            // Doğru kutuların sayısını sıfırla
            correctBoxes = [];
            
            // Durum değişkenlerini sıfırla
            isSpinning = true;
            highlightedBoxes = [];
            correctBox = null;
            
            // Timer rengini başlangıçta yeşil yap
            timerEl.style.color = '#33ff33';
            timerEl.style.animation = '';
            
            // Connect butonunu güncelle
            updateConnectButton();
            
            // Shield'ı gizle
            shieldEl.style.display = 'none';
            
            // Bağlantı çizgilerini güncelle
            setTimeout(updateConnectorLines, 100);
            
            // Kilit ikonlarını oluştur
            setTimeout(createLockIcons, 100);
        }
        
        // Kutulardaki karakterleri döndürme efekti
        function startSpinning() {
            // Önceki interval'leri temizle
            spinningIntervals.forEach(interval => clearInterval(interval));
            spinningIntervals = [];
            
            const codeBoxes = codeRowEl.querySelectorAll('.box');
            
            // Aşama 1'de tüm kutularda tüm karakterler döner
            if (currentStage === 1) {
                // Tüm kutular için aynı hızı kullan
                const speed = 150; // Aşama 1 için sabit hız
                
                codeBoxes.forEach((box, index) => {
                    const spinner = box.querySelector('.spinner');
                    let charIndex = 0;
                    
                    const interval = setInterval(() => {
                        charIndex = (charIndex + 1) % characterSets[index].length;
                        spinner.textContent = characterSets[index][charIndex];
                    }, speed);
                    
                    spinningIntervals.push(interval);
                    boxStates[index] = true; // true = dönen
                });
            } 
            // Aşama 2'de üst kutudaki karaktere göre döner
            else {
                // 2. aşama için hız değerleri (kutu bazında saklanacak)
                if (!boxSpeeds) {
                    // İlk kez çağrıldığında hız değerlerini oluştur
                    boxSpeeds = [];
                    for (let i = 0; i < 9; i++) {
                        boxSpeeds[i] = 100 + Math.random() * 100; // 100-200 ms arası
                    }
                }
                
                // Mevcut karakter indeksleri (kaldığı yerden devam için)
                if (!charIndices) {
                    charIndices = Array(9).fill(0);
                }
                
                codeBoxes.forEach((box, index) => {
                    // Bu kutu çözülmüş mü kontrol et
                    if (correctBoxes.includes(index)) {
                        box.classList.add('solved');
                        return; // Çözülmüşse döngüye katma
                    }
                    
                    const spinner = box.querySelector('.spinner');
                    
                    // Üst kutudaki karakteri kontrol et
                    const upperBoxChar = passwordRow[index];
                    
                    // Karakter tipine göre uygun set belirle
                    let charSet;
                    if (!isNaN(upperBoxChar)) {
                        // Rakam ise
                        charSet = numbersOnly;
                    } else {
                        // Harf ise
                        charSet = lettersOnly;
                    }
                    
                    // Mevcut hızı kullan
                    const speed = boxSpeeds[index];
                    
                    const interval = setInterval(() => {
                        charIndices[index] = (charIndices[index] + 1) % charSet.length;
                        spinner.textContent = charSet[charIndices[index]];
                    }, speed);
                    
                    spinningIntervals.push(interval);
                    boxStates[index] = true; // true = dönen
                });
            }
            
            isSpinning = true;
            updateConnectButton();
        }
        
        // Timer'ı güncelleme
        function updateTimer() {
            if (timer > 0) {
                timer--;
                timerEl.textContent = timer;
                
                // Son 10 saniye kırmızı yanıp sönsün, öncesinde yeşil kalsın
                if (timer <= 10) {
                    timerEl.style.color = '#ff3333'; // Kırmızı
                    timerEl.style.animation = 'blink 1s infinite';
                } else {
                    timerEl.style.color = '#33ff33'; // Yeşil
                    timerEl.style.animation = '';
                }
            } else {
                clearInterval(timerInterval);
                timeUp();
            }
        }
        
        // Süre dolduğunda
        function timeUp() {
            // Döngüleri durdur
            stopSpinning();
            
            // Süre bitti ekranını göster
            timeUpScreen.classList.remove('hidden');
            
            // Ekrandaki retry butonu için ek bilgi
            if (currentStage === 2) {
                // 2. aşamada zaten çözülmüş kutular varsa göster
                const solvedCount = correctBoxes.length;
                if (solvedCount > 0) {
                    document.getElementById('retry-message').innerHTML = 
                        `${solvedCount} kutu eşleştirildi! Geri kalan kutuları da tamamla.`;
                    document.getElementById('retry-message').style.display = 'block';
                } else {
                    document.getElementById('retry-message').style.display = 'none';
                }
            }
        }
        
        // Tüm dönmeleri durdur
        function stopSpinning() {
            spinningIntervals.forEach(interval => clearInterval(interval));
            spinningIntervals = [];
            isSpinning = false;
        }
        
        // Tek bir kutuyu başlat/durdur (2. aşama için)
        function toggleBoxSpinning(index) {
            const codeBoxes = codeRowEl.querySelectorAll('.box');
            const box = codeBoxes[index];
            
            // Bu kutu çözülmüş mü?
            if (correctBoxes.includes(index)) {
                return; // Çözülmüş kutuyu değiştirme
            }
            
            // Kutu zaten seçili mi?
            if (selectedBox === index) {
                // Seçili kutuya tekrar tıklandı - durdur/başlat
                if (boxStates[index]) {
                    // Kutu dönüyorsa durdur
                    clearInterval(spinningIntervals[index]);
                    spinningIntervals[index] = null;
                    boxStates[index] = false;
                    box.classList.add('selected');
                } else {
                    // Kutu duruyorsa yeniden başlat
                    const upperBoxChar = passwordRow[index];
                    let charSet;
                    
                    if (!isNaN(upperBoxChar)) {
                        // Rakam ise
                        charSet = numbersOnly;
                    } else {
                        // Harf ise
                        charSet = lettersOnly;
                    }
                    
                    const spinner = box.querySelector('.spinner');
                    // Mevcut karakter indeksinden devam et - bu değişmedi
                    
                    // Mevcut hızı kullan, yeni hız oluşturma
                    const speed = boxSpeeds[index];
                    
                    const interval = setInterval(() => {
                        charIndices[index] = (charIndices[index] + 1) % charSet.length;
                        spinner.textContent = charSet[charIndices[index]];
                    }, speed);
                    
                    spinningIntervals[index] = interval;
                    boxStates[index] = true;
                    
                    // Seçimi koru, sadece döndür
                    box.classList.add('selected');
                }
            } else {
                // Yeni bir kutu seçildi
                // Önceki seçili kutuyu temizle
                if (selectedBox !== null) {
                    const prevSelectedBox = codeBoxes[selectedBox];
                    prevSelectedBox.classList.remove('selected'); // Parlama efektini kaldır
                    
                    // Önceki seçili kutu duruyorsa, tekrar başlat
                    if (!boxStates[selectedBox]) {
                        // Önceki kutuyu yeniden başlat
                        const upperBoxChar = passwordRow[selectedBox];
                        let charSet;
                        
                        if (!isNaN(upperBoxChar)) {
                            charSet = numbersOnly;
                        } else {
                            charSet = lettersOnly;
                        }
                        
                        const spinner = prevSelectedBox.querySelector('.spinner');
                        const speed = boxSpeeds[selectedBox];
                        
                        const interval = setInterval(() => {
                            charIndices[selectedBox] = (charIndices[selectedBox] + 1) % charSet.length;
                            spinner.textContent = charSet[charIndices[selectedBox]];
                        }, speed);
                        
                        spinningIntervals[selectedBox] = interval;
                        boxStates[selectedBox] = true;
                    }
                }
                
                // Yeni kutuyu seçili olarak işaretle
                selectedBox = index;
                box.classList.add('selected');
                
                // Kutu durumunu değiştirme - sadece seçili olarak işaretle
                // İkinci bir tıklama gerçekleştiğinde kutu durdurulacak
            }
            
            // Connect butonunu güncelle
            updateConnectButton();
        }
        
        // Connect butonunun durumunu güncelle
        function updateConnectButton() {
            if (currentStage === 1) {
                // Aşama 1 için CONNECT/SEARCH
                if (isSpinning) {
                    connectBtn.textContent = 'CONNECT';
                    connectBtn.classList.remove('btn-active');
                    connectBtn.classList.remove('connect-stage2');
                } else {
                    connectBtn.textContent = 'SEARCH';
                    connectBtn.classList.add('btn-active');
                    connectBtn.classList.remove('connect-stage2');
                }
            } else {
                // Aşama 2 için BAĞLAN
                connectBtn.textContent = 'BAĞLAN';
                connectBtn.classList.add('connect-stage2');
                
                // Eğer seçili kutu varsa butonu aktif yap
                if (selectedBox !== null && !boxStates[selectedBox]) {
                    connectBtn.classList.add('btn-active');
                } else {
                    connectBtn.classList.remove('btn-active');
                }
            }
        }
        
        // Connect butonu tıklaması
        function handleConnectClick() {
            if (currentStage === 1) {
                // 1. aşama için yeni mantık
                if (isSpinning) {
                    // Döngüyü durdur
                    stopSpinning();
                    
                    // Aktif kilit ikonunu seç
                    selectActiveLock();
                    
                    // Connect butonunu güncelle
                    updateConnectButton();
                } else {
                    // Start butonuna tıklandı - döngüyü yeniden başlat
                    
                    // Parlayan kutuları temizle
                    clearHighlightedBoxes();
                    
                    // Döngüyü yeniden başlat
                    startSpinning();
                    
                    // Connect butonunu güncelle
                    updateConnectButton();
                }
            } else {
                // 2. aşama için kutu eşleştirme kontrolü - değişiklik yok
                checkStage2Match();
                // Buton durumunu güncelle (eşleşme sonrası)
                updateConnectButton();
            }
        }
        
        // Aktif kilit ikonunu seç
        function selectActiveLock() {
            // Onaylanmamış kilit ikonları için aday listesi oluştur
            const candidates = [];
            
            for (let i = 0; i < 8; i++) {
                // Bir kilit ikonu, iki kutuyu bağlar (i ve i+1)
                // Eğer bu kilit ikonunu seçebilmek için, iki kutusundan en az birinin henüz onaylanmamış olması gerekir
                if (!correctBoxes.includes(i) || !correctBoxes.includes(i+1)) {
                    candidates.push(i);
                }
            }
            
            // Eğer aday yoksa, tüm kutular zaten onaylanmış demektir - oyun tamamlandı
            if (candidates.length === 0) {
                stageComplete();
                return;
            }
            
            // Adaylar arasından rastgele bir kilit ikonu seç
            const randomIndex = Math.floor(Math.random() * candidates.length);
            const activeLockIndex = candidates[randomIndex];
            
            // Bu kilit ikonunun işaret ettiği iki kutu
            highlightedBoxes = [activeLockIndex, activeLockIndex + 1];
            
            // Kutulardan doğru olanı belirle
            if (correctBoxes.includes(activeLockIndex)) {
                // İlk kutu onaylanmışsa, ikinci kutu doğrudur
                correctBox = activeLockIndex + 1;
            } else if (correctBoxes.includes(activeLockIndex + 1)) {
                // İkinci kutu onaylanmışsa, ilk kutu doğrudur
                correctBox = activeLockIndex;
            } else {
                // İkisi de onaylanmamışsa, rastgele birini doğru belirle
                correctBox = Math.random() < 0.5 ? activeLockIndex : activeLockIndex + 1;
            }
            
            // İlgili kilit ikonunu parlat
            highlightLockIcon();
        }
        
        // Parlayan kutuları temizle
        function clearHighlightedBoxes() {
            const codeBoxes = codeRowEl.querySelectorAll('.box');
            highlightedBoxes.forEach(index => {
                codeBoxes[index].classList.remove('highlight');
            });
            highlightedBoxes = [];
            correctBox = null;
            
            // Tüm kilit ikonlarından highlight sınıfını kaldır
            const lockIcons = document.querySelectorAll('.lock-icon');
            lockIcons.forEach(icon => {
                icon.classList.remove('highlight');
            });
        }
        
        // İlgili kilit ikonunu vurgula
        function highlightLockIcon() {
            if (highlightedBoxes.length === 2 && highlightedBoxes[0] + 1 === highlightedBoxes[1]) {
                // Yan yana iki kutu varsa, aralarındaki kilidi vurgula
                const lockIcons = document.querySelectorAll('.lock-icon');
                const lockIndex = highlightedBoxes[0];
                
                if (lockIcons[lockIndex]) {
                    // Diğer vurguları temizle
                    lockIcons.forEach(icon => icon.classList.remove('highlight'));
                    // İlgili kilidi vurgula
                    lockIcons[lockIndex].classList.add('highlight');
                }
            }
        }
        
        // Kutuya tıklama işleyicisi
        function handleBoxClick(index) {
            // 1. aşamada sadece döngü durduğunda tepki versin
            if (currentStage === 1) {
                // Sadece döngü durdurulmuşsa tıklamayı işle
                if (!isSpinning && highlightedBoxes.includes(index)) {
                    const codeBoxes = codeRowEl.querySelectorAll('.box');
                    const passwordBoxes = passwordRowEl.querySelectorAll('.box');
                    
                    if (index === correctBox) {
                        // Doğru kutu seçildi
                        
                        // Seçili kutunun o anki değerini al
                        const currentChar = codeBoxes[index].querySelector('.spinner').textContent;
                        
                        // Password kutusuna ata
                        passwordBoxes[index].textContent = currentChar;
                        passwordBoxes[index].classList.add('solved');
                        
                        // Kutunun çerçevesini kısa süre vurgula, sonra sadece karakterin rengini koru
                        passwordBoxes[index].classList.add('temp-solved-border');
                        setTimeout(() => {
                            passwordBoxes[index].classList.remove('temp-solved-border');
                        }, 500);
                        
                        // Yukarı taşınma efekti - daha güçlü pulse animasyonu
                        passwordBoxes[index].style.animation = 'pulse 0.5s';
                        setTimeout(() => {
                            passwordBoxes[index].style.animation = '';
                        }, 500);
                        
                        // Doğru kutuları kaydet
                        correctBoxes.push(index);
                        
                        // Başarı göstergesi
                        codeBoxes[index].classList.add('success');
                        setTimeout(() => {
                            codeBoxes[index].classList.remove('success');
                        }, 500);
                        
                        // Kilit ikonlarının durumunu güncelle
                        updateLockIconStates();
                        
                        // Tüm kutular doğru mu kontrol et
                        if (correctBoxes.length === 9) {
                            playCompletionAnimation();
                            return; // Oyun tamamlandı, fonksiyondan çık
                        }
                        
                        // Kutuların vurgulanmasını sürdür (SEARCH butonuna basılana kadar)
                        // isSpinning = false kalacak, böylece buton "SEARCH" olarak gösterilecek
                        // CONNECT butonuna basıldığında spin başlayacak ve buton CONNECT'e dönecek
                    } else {
                        // Yanlış kutu seçildi
                        
                        // Hata animasyonu - kısa süreli kırmızı yanıp sönme
                        codeBoxes[index].classList.add('error');
                        
                        setTimeout(() => {
                            // Kısa süre sonra hata stilini kaldır
                            codeBoxes[index].classList.remove('error');
                            
                            // Parlayan kutuları temizle
                            clearHighlightedBoxes();
                            
                            // Döngüyü yeniden başlat (otomatik)
                            startSpinning();
                            updateConnectButton();
                        }, 200); // 0.2 saniye hata gösterimi
                    }
                }
            } else if (currentStage === 2) {
                // 2. aşamada kutu seçme ve durdurma/başlatma mantığı
                toggleBoxSpinning(index);
            }
        }
        
        // Özel tamamlanma animasyonu
        function playCompletionAnimation() {
            // Tüm döngüleri durdur
            stopSpinning();
            
            // Üst kutularda dalgalanma efekti
            const passwordBoxes = passwordRowEl.querySelectorAll('.box');
            passwordBoxes.forEach(box => {
                box.style.animation = 'pulse 0.5s infinite alternate';
            });
            
            // 3 saniye sonra tamamlanma ekranını göster
            setTimeout(() => {
                stageComplete();
            }, 3000);
        }
        
        // String'i karıştır
        function shuffleString(str) {
            const array = str.split('');
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array.join('');
        }
        
        // Birinci aşama tamamlandı
        function stageComplete() {
            clearInterval(timerInterval);
            stageCompleteScreen.classList.remove('hidden');
            stopSpinning();
        }
        
        // İkinci aşamayı başlat
        function startStage2() {
            currentStage = 2;
            stageCompleteScreen.classList.add('hidden');
            
            // Kilit ikonlarını gizle (Aşama 2'de gösterilmeyecek)
            const lockIcons = document.querySelectorAll('.lock-icon');
            lockIcons.forEach(icon => {
                icon.classList.remove('active');
            });
            
            // Aşama göstergesini güncelle
            stageIndicator.textContent = "AŞAMA 2/2";
            
            // Password row değerlerini koru
            const passwordBoxes = passwordRowEl.querySelectorAll('.box');
            const codeBoxes = codeRowEl.querySelectorAll('.box');
            
            // Önceki çözümleri temizle - süre dolduğunda tüm kutular yeniden başlatılsın
            correctBoxes = [];
            passwordRow = [];
            
            for (let i = 0; i < 9; i++) {
                // Üst kutulardaki değerleri al
                passwordRow.push(passwordBoxes[i].textContent);
                
                // Önceki çözüm stillerini kaldır
                codeBoxes[i].classList.remove('solved', 'success', 'selected', 'error', 'highlight');
                
                // Password kutularını solved stilinde göster (ama success stilini kaldır)
                passwordBoxes[i].classList.remove('success');
                passwordBoxes[i].classList.add('solved');
            }
            
            // 2. aşama için değişkenleri hazırla
            boxSpeeds = [];
            charIndices = Array(9).fill(0);
            
            // Her kutu için sabit bir hız belirle (oyun boyunca değişmeyecek)
            for (let i = 0; i < 9; i++) {
                boxSpeeds[i] = 100 + Math.random() * 100; // 100-200 ms arası
            }
            
            // Connect butonunun metnini değiştir
            connectBtn.textContent = 'BAĞLAN';
            connectBtn.classList.add('connect-stage2');
            connectBtn.classList.remove('btn-active');
            
            // Timer'ı sıfırla ve yeniden başlat
            timer = 90;
            timerEl.textContent = timer;
            timerEl.style.animation = '';
            timerEl.style.color = '#33ff33'; // Yeşil renk başlangıçta
            
            // Timer'ı başlat
            clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);
            
            // Kutu durumlarını sıfırla
            boxStates = Array(9).fill(true); // Başlangıçta tüm kutular döner
            
            // Seçili kutuyu sıfırla
            selectedBox = null;
            
            // Döndürmeyi yeniden başlat
            startSpinning();
            
            // Durum değişkenlerini sıfırla
            isSpinning = true;
            highlightedBoxes = [];
            
            // Connect butonunu güncelle
            updateConnectButton();
            
            // Bağlantı çizgilerini güncelle
            setTimeout(updateConnectorLines, 100);
        }
        
        // Oyun kazanıldı
        function winGame() {
            clearInterval(timerInterval);
            winScreen.classList.remove('hidden');
            stopSpinning();
        }
        
        // 2. aşamada kutu eşleşmesini kontrol et
        function checkStage2Match() {
            const codeBoxes = codeRowEl.querySelectorAll('.box');
            const passwordBoxes = passwordRowEl.querySelectorAll('.box');
            
            // Seçili bir kutu var mı ve bu kutu durdurulmuş mu kontrol et
            if (selectedBox !== null && boxStates[selectedBox] === false) {
                // Seçili kutunun o anki değerini al
                const currentChar = codeBoxes[selectedBox].querySelector('.spinner').textContent;
                
                // Password'deki karakter ile karşılaştır
                if (currentChar === passwordRow[selectedBox]) {
                    // Doğru eşleşme - görsel geri bildirim 
                    codeBoxes[selectedBox].classList.add('success');
                    passwordBoxes[selectedBox].classList.add('success');
                    
                    // Hafif titreşim animasyonu
                    codeBoxes[selectedBox].style.animation = 'pulse 0.5s';
                    passwordBoxes[selectedBox].style.animation = 'pulse 0.5s';
                    
                    setTimeout(() => {
                        codeBoxes[selectedBox].style.animation = '';
                        passwordBoxes[selectedBox].style.animation = '';
                    }, 500);
                    
                    // Doğru kutuları kaydet
                    if (!correctBoxes.includes(selectedBox)) {
                        correctBoxes.push(selectedBox);
                    }
                    
                    // Kutunun artık seçilemeyen duruma getirilmesi
                    codeBoxes[selectedBox].classList.remove('selected');
                    codeBoxes[selectedBox].classList.add('solved');
                    passwordBoxes[selectedBox].classList.add('solved');
                    
                    // Seçimi kaldır
                    selectedBox = null;
                    
                    // Tüm kutular doğru mu kontrol et
                    if (correctBoxes.length === 9) {
                        setTimeout(finalAnimation, 500);
                    }
                } else {
                    // Eşleşme yok - hata göster
                    codeBoxes[selectedBox].classList.add('error');
                    setTimeout(() => {
                        codeBoxes[selectedBox].classList.remove('error');
                        // Kutuyu yeniden başlat
                        toggleBoxSpinning(selectedBox);
                    }, 800);
                }
            } else if (selectedBox === null) {
                // Hiç kutu seçili değilse uyarı
                alert("Lütfen önce bir kutu seçin ve durdurun!");
            } else if (boxStates[selectedBox]) {
                // Kutu seçili ama durdurulmamış
                alert("Lütfen seçili kutuyu durdurmak için üzerine tıklayın!");
            }
        }
        
        // Final animasyonu - tüm kutular eşleştiğinde
        function finalAnimation() {
            // Tüm döngüleri durdur
            stopSpinning();
            
            // Aşama göstergesini değiştir
            stageIndicator.textContent = "KİLİT AÇILIYOR";
            stageIndicator.style.color = "#00ffff";
            stageIndicator.classList.add('glitch-effect');
            
            // Üst kutularda dalgalanma efekti
            const passwordBoxes = passwordRowEl.querySelectorAll('.box');
            passwordBoxes.forEach(box => {
                box.style.animation = 'pulse 0.5s infinite alternate';
            });
            
            // Alt kutularda final karakterleri gösterme
            const codeBoxes = codeRowEl.querySelectorAll('.box');
            
            // İlk aşama - tüm kutularda hızlı scramble
            codeBoxes.forEach((box, index) => {
                const spinner = box.querySelector('.spinner');
                let localIndex = 0;
                
                // Glitch efekti ekle
                box.classList.add('glitch-effect');
                
                // Karakterleri hızla değiştir
                const changeInterval = setInterval(() => {
                    localIndex = (localIndex + 1) % characters.length;
                    spinner.textContent = characters[localIndex];
                }, 50);
                
                // Belirli bir süre sonra final karakterini göster
                setTimeout(() => {
                    clearInterval(changeInterval);
                    
                    // Animasyonu kaldır
                    box.classList.remove('glitch-effect');
                    
                    // Gecikme ile sırayla karakterleri görüntüle
                    setTimeout(() => {
                        spinner.textContent = finalCharacters[index];
                        box.classList.add('solved');
                        
                        // Son kutu gösterildiyse
                        if (index === 8) {
                            setTimeout(() => {
                                // Tüm kutularda "E-A-Y-D-I-N-1-2-3" mesajı 
                                passwordBoxes.forEach((box, idx) => {
                                    box.textContent = finalCharacters[idx];
                                    box.classList.add('glitch-effect');
                                });
                                
                                setTimeout(winGame, 3000);
                            }, 1000);
                        }
                    }, index * 300); // Her kutu 300ms ara ile
                }, 2000); // 2 saniye scramble
            });
        }
        
        // Kutular arası mesafe değişkenini hesapla ve CSS'e ekle
        function updateConnectorLines() {
            const passwordBoxes = document.querySelectorAll('.password-box');
            const codeBoxes = document.querySelectorAll('.code-row .box');
            
            if (passwordBoxes.length > 0 && codeBoxes.length > 0) {
                // İlk üst kutu ve ilk alt kutu arasındaki mesafeyi hesapla
                const passwordBox = passwordBoxes[0].getBoundingClientRect();
                const codeBox = codeBoxes[0].getBoundingClientRect();
                
                // Üst kutunun altından alt kutunun üstüne olan mesafe
                const distance = codeBox.top - passwordBox.bottom;
                
                // Bu mesafeyi CSS değişkeni olarak ekle
                document.documentElement.style.setProperty('--box-spacing', distance + 'px');
                
                // Kilit ikonunun konumunu güncelle
                if (window.matchMedia("(orientation: portrait)").matches) {
                    // Dikey ekranda
                    const lockIcon = document.querySelector('.lock-icon');
                    if (lockIcon) {
                        lockIcon.style.top = `calc(${passwordBox.bottom}px + ${distance/2}px - 18px)`;
                    }
                }
            }
        }
        
        // Kilit ikonlarının durumunu güncelle (çözülmüş kutulara göre)
        function updateLockIconStates() {
            const lockIcons = document.querySelectorAll('.lock-icon');
            
            // Her bir kilit ikonu için kontrol et
            for (let i = 0; i < 8; i++) {
                const lockIcon = lockIcons[i];
                
                // Bu kilit ikonu, i ve i+1 kutularını bağlıyor
                // Eğer her iki kutu da çözülmüşse, kilit ikonu da çözülmüş olarak işaretle
                if (correctBoxes.includes(i) && correctBoxes.includes(i+1)) {
                    lockIcon.classList.remove('highlight');
                    lockIcon.classList.add('solved');
                } 
                // Eğer bu kilit ikonu vurgulanmış ve onunla bağlantılı kutulardan biri seçilmişse
                // vurguyu koru (doğru/yanlış seçim sonrası)
                else if (highlightedBoxes.includes(i) && highlightedBoxes.includes(i+1)) {
                    lockIcon.classList.add('highlight');
                    lockIcon.classList.remove('solved');
                } 
                // Hiçbiri değilse normal görünüm
                else {
                    lockIcon.classList.remove('highlight', 'solved');
                }
            }
        }
        
        // Orijinal olay dinleyicileri - diğer event listenerlarınız buraya
        window.addEventListener('load', function() {
            // Mevcut load event listener içeriği
            // Ekran yönünü kontrol et
            checkOrientation();
            
            // Connect butonu olayını ayarla
            connectBtn.addEventListener('click', handleConnectClick);
            connectBtn.addEventListener('touchstart', function(e) {
                e.preventDefault();
                handleConnectClick();
            });
            
            // Aşama 2 için kutu tıklama olaylarını ekle
            const codeBoxes = codeRowEl.querySelectorAll('.box');
            codeBoxes.forEach((box, index) => {
                box.addEventListener('click', function() {
                    handleBoxClick(index);
                });
                
                // Dokunmatik cihazlar için
                box.addEventListener('touchstart', function(e) {
                    e.preventDefault(); // Çift olay tetiklenmesini önle
                    handleBoxClick(index);
                });
            });
            
            // Klavye olaylarını dinle (Boşluk/Enter tuşları için)
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    connectBtn.click();
                }
            });
            
            // Ekran döndürme olayını dinle
            window.addEventListener('resize', handleResize);
            
            // Kilit ikonlarını oluştur ve konumlandır
            createLockIcons();
            
            // Bağlantı çizgilerini güncelle
            updateConnectorLines();
        });
        
        // Ekran yönünü kontrol et
        function checkOrientation() {
            // Yatay ekran kontrolü
            if (window.innerWidth < window.innerHeight) {
                // Dikey ekran, uyarı göster
                alert("Bu oyun yatay ekranda daha iyi çalışır. Lütfen cihazınızı yatay konuma çevirin.");
            }
        }

        // Window yeniden boyutlandığında da kutular arası mesafeyi güncelle
        window.addEventListener('resize', handleResize);
        
        // Kilit ikonlarını oluştur ve konumlandır
        function createLockIcons() {
            // Sadece 1. aşamada kilit ikonlarını göster
            if (currentStage !== 1) {
                // Aşama 1 değilse tüm kilit ikonlarını gizle
                const lockContainer = document.getElementById('lock-container');
                lockContainer.innerHTML = '';
                return;
            }
            
            const container = document.querySelector('.game-container');
            const containerRect = container.getBoundingClientRect();
            const lockContainer = document.getElementById('lock-container');
            
            // Önceki kilit ikonlarını temizle
            lockContainer.innerHTML = '';
            
            // Password row ve code row kutularını al
            const passwordBoxes = passwordRowEl.querySelectorAll('.box');
            const codeBoxes = codeRowEl.querySelectorAll('.box');
            
            // 8 adet dikey kablo bağlantısı (9 kutu arasında 8 bağlantı) için kilit ikon oluştur
            for (let i = 0; i < 8; i++) {
                // Yan yana iki dikey kablo için:
                const box1 = passwordBoxes[i].getBoundingClientRect();
                const box2 = passwordBoxes[i+1].getBoundingClientRect();
                
                // İki kutunun X koordinatlarının ortasını hesapla
                const x1 = box1.left + box1.width/2;
                const x2 = box2.left + box2.width/2;
                const iconX = (x1 + x2) / 2;
                
                // Y koordinatını kabloların ortasında olacak şekilde hesapla
                const passwordBox = box1;
                const codeBox = codeBoxes[i].getBoundingClientRect();
                const iconY = passwordBox.bottom + (codeBox.top - passwordBox.bottom) / 2;
                
                // Container'a göre rölatif pozisyonu hesapla
                const relativeX = iconX - containerRect.left;
                const relativeY = iconY - containerRect.top;
                
                // Kilit ikonunu oluştur
                const lockIcon = document.createElement('div');
                lockIcon.className = 'lock-icon active';
                lockIcon.dataset.index = i; // Hangi kutu çiftine ait olduğunu belirle
                lockIcon.style.left = `${relativeX}px`;
                lockIcon.style.top = `${relativeY}px`;
                lockIcon.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                `;
                
                // Kilit ikonunu container'a ekle
                lockContainer.appendChild(lockIcon);
            }
            
            // Kilit ikonlarının durumlarını güncelle
            updateLockIconStates();
        }
    </script>
</body>
</html> 
